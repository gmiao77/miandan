<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>跨境电商物流合规面单编辑器</title>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .template-card {
        @apply border border-gray-200 rounded-md p-2 mb-3 cursor-pointer hover:bg-gray-50 transition-all;
      }
      .template-card.active {
        @apply border-blue-500 bg-blue-50;
      }
      .asset-card {
        @apply border border-gray-200 rounded-md p-2 mb-2 cursor-pointer hover:bg-gray-50 transition-all;
      }
      .canvas-container {
        @apply border border-gray-300 rounded-md bg-white relative overflow-hidden;
      }
      .canvas-element {
        @apply absolute select-none;
      }
      .editable {
        /* 避免在拖动时显示光标，编辑时仍然有效 */
        @apply cursor-move; 
        outline-offset: 4px; /* 增加轮廓偏移，更容易点击边缘拖动 */
        min-width: 20px; /* 确保最小可点击区域 */
      }
      /* 缩放手柄样式 */
      .resize-handle {
        @apply absolute w-4 h-4 bg-blue-500 rounded-full border border-white shadow-md z-10 hidden;
      }
      /* 选中时显示手柄 */
      .selected .resize-handle {
        @apply block;
      }
      .resize-handle-tl { top: -6px; left: -6px; cursor: nwse-resize; }
      .resize-handle-tr { top: -6px; right: -6px; cursor: nesw-resize; }
      .resize-handle-bl { bottom: -6px; left: -6px; cursor: nesw-resize; }
      .resize-handle-br { bottom: -6px; right: -6px; cursor: nwse-resize; }
      
      /* 选中元素轮廓 */
      .canvas-element.selected {
        @apply outline outline-2 outline-blue-500;
      }
      
      /* 确保图片元素在容器内显示 */
      .canvas-element img {
        display: block;
        max-width: 100%;
        max-height: 100%;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
    }
  </style>
</head>
<body class="flex h-screen bg-gray-100 overflow-hidden">

  <div class="w-16 flex flex-col items-center py-4 border-r border-gray-200 bg-white">
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-paint-brush text-xl mb-1"></i>
      <span class="text-xs">绘制</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-blue-600 transition-colors">
      <i class="fa fa-font text-xl mb-1"></i>
      <span class="text-xs">文字</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-square-o text-xl mb-1"></i>
      <span class="text-xs">形状</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-picture-o text-xl mb-1"></i>
      <span class="text-xs">标志</span>
    </button>
    <button class="flex flex-col items-center text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-th-large text-xl mb-1"></i>
      <span class="text-xs">模板</span>
    </button>
  </div>

  <div class="w-72 border-r border-gray-200 flex flex-col bg-white">
    <div class="border-b border-gray-200">
      <div class="flex">
        <button id="templateTab" class="flex-1 py-3 text-center text-sm font-medium text-gray-500 hover:text-gray-700">
          模板库
        </button>
        <button id="textTab" class="flex-1 py-3 text-center text-sm font-medium text-blue-600 border-b-2 border-blue-600">
          文本库
        </button>
        <button id="assetTab" class="flex-1 py-3 text-center text-sm font-medium text-gray-500 hover:text-gray-700">
          标志库
        </button>
      </div>
    </div>

    <div id="templateLibrary" class="hidden flex-1 overflow-y-auto scrollbar-hide p-3">
      <div class="mb-4">
        <input type="text" id="templateSearch" placeholder="搜索合规模板" 
               class="w-full px-3 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        <div class="flex mt-2 space-x-1">
          <button class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm">全部</button>
          <button class="px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100">寄件人</button>
          <button class="px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100">制造商</button>
        </div>
      </div>
      <div id="templateList" class="space-y-2">
        <div class="text-center text-gray-500 py-10">加载模板中...</div>
      </div>
    </div>
    
    <div id="textLibrary" class="flex-1 overflow-y-auto scrollbar-hide p-3">
        <div id="textList" class="space-y-2">
            <div class="text-center text-gray-500 py-10">加载文本模板中...</div>
        </div>
    </div>

    <div id="assetLibrary" class="hidden flex-1 overflow-y-auto scrollbar-hide p-3">
      <div class="mb-4">
        <input type="text" id="assetSearch" placeholder="搜索标志（如：窒息警告）" 
               class="w-full px-3 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        
        <div class="mt-3 overflow-x-auto scrollbar-hide">
          <div class="flex space-x-2 pb-2 min-w-max">
            <button class="asset-category-btn px-3 py-1 bg-blue-500 text-white rounded-md text-sm" data-category="all">
              全部
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="代理">
              代理
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="法国标">
              法国标
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="化妆品">
              化妆品
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="能效">
              能效
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="纽扣电池">
              纽扣电池
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="西班牙回收">
              西班牙回收
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="窒息警告">
              窒息警告
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="其他">
              其他
            </button>
          </div>
        </div>
      </div>

      <div id="assetList" class="space-y-3">
        <div class="text-center text-gray-500 py-10">加载标志中...</div>
      </div>
    </div>
  </div>

  <div class="flex-1 flex flex-col overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
      <div class="text-sm text-gray-500 flex items-center">
        <i class="fa fa-info-circle mr-1"></i>
        <span>合规面单请确保所有信息完整，标志位置正确</span>
      </div>
      <div class="flex items-center">
        <span class="text-sm mr-2">画布尺寸:</span>
        <input type="number" id="canvasWidth" value="210" min="50" max="500" 
               class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
        <span class="mx-1">×</span>
        <input type="number" id="canvasHeight" value="148" min="50" max="500" 
               class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
        <span class="ml-1 mr-3">mm</span>
        <button id="applySizeBtn" class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">应用</button>
      </div>
    </div>
    
    <div class="flex-1 p-6 overflow-auto bg-gray-50">
      <div class="max-w-4xl mx-auto">
        <div id="canvasContainer" class="canvas-container mx-auto transition-all duration-300" 
             style="width: 210mm; height: 148mm;">
          <div id="canvas" class="w-full h-full relative">
            <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">
              请从左侧选择模板或标志添加到画布
            </div>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end">
          <div class="relative inline-block">
            <button id="exportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
              导出合规面单 <i class="fa fa-download ml-1"></i>
            </button>
            <div id="exportOptions" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
              <button data-format="pdf" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-pdf-o mr-2 text-red-500"></i>PDF格式（推荐）
              </button>
              <button data-format="png" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-image-o mr-2 text-green-500"></i>PNG格式
              </button>
              <button data-format="jpg" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-image-o mr-2 text-yellow-500"></i>JPG格式
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="propertyPanel" class="fixed top-16 right-6 w-56 p-4 bg-white rounded-lg shadow-xl hidden z-20">
    <h3 class="text-sm font-bold mb-3 border-b pb-2 text-gray-700">文本属性</h3>
    <div id="textControls" class="space-y-3">
      <div class="flex justify-between items-center">
        <label for="fontSizeSelect" class="text-sm text-gray-600">字号 (px):</label>
        <select id="fontSizeSelect" class="w-24 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-blue-500 focus:border-blue-500">
          </select>
      </div>
    </div>
  </div>


    <script>
        // 对应 templates/text.json 的模板 ID 和路径
        const TEXT_TEMPLATE_ID = 'text-template'; 
        const TEXT_TEMPLATE_PATH = './templates/text.json';

        // text.json 对应的元数据 (用于文本列表展示)
        const TEXT_TEMPLATE_META = {
            id: TEXT_TEMPLATE_ID,
            name: '内置文本框',
            description: '点击插入一个可移动、可编辑的文本框。',
            thumbnail: 'https://via.placeholder.com/100x75/007bff/ffffff?text=Text+Box', 
            path: TEXT_TEMPLATE_PATH, 
            size: { width: 210, height: 148, unit: 'mm' } 
        };

        const state = {
          currentTemplate: null,
          allTemplates: [],        // 普通模板（寄件人、制造商等）
          allTextTemplates: [],    // 文本模板
          allAssets: [],
          filteredAssets: [],
          currentCategory: 'all',
          repoName: 'miandan' 
        };
    
        const assetCategories = [
          '代理', '法国标', '化妆品', '能效', 
          '纽扣电池', '西班牙回收', '窒息警告', '其他'
        ];
    
        // DOM元素
        const canvas = document.getElementById('canvas');
        const canvasContainer = document.getElementById('canvasContainer');
        const canvasWidthInput = document.getElementById('canvasWidth');
        const canvasHeightInput = document.getElementById('canvasHeight');
        const applySizeBtn = document.getElementById('applySizeBtn');
        const exportBtn = document.getElementById('exportBtn');
        const exportOptions = document.getElementById('exportOptions');
        
        // Tab Buttons
        const templateTab = document.getElementById('templateTab');
        const textTab = document.getElementById('textTab');
        const assetTab = document.getElementById('assetTab');
        
        // Library Panels
        const templateLibrary = document.getElementById('templateLibrary');
        const textLibrary = document.getElementById('textLibrary');
        const assetLibrary = document.getElementById('assetLibrary');
        
        // List Containers
        const templateListEl = document.getElementById('templateList');
        const textListEl = document.getElementById('textList');
        const assetListEl = document.getElementById('assetList');
        
        // Search/Controls
        const templateSearchInput = document.getElementById('templateSearch');
        const assetSearchInput = document.getElementById('assetSearch');
        const propertyPanel = document.getElementById('propertyPanel');
        const fontSizeSelect = document.getElementById('fontSizeSelect');
        let selectedTextElement = null; 
    
        const MM_TO_PX = 3.779528;
        const PX_TO_MM = 0.264583;
    
        // 初始化
        async function init() {
          await Promise.all([
            loadTemplateMetadata(),
            loadAllAssets()
          ]);
          populateFontSizeOptions(); 
          initEventListeners();
          initInteractJs(); 
        }

        // 填充字号选项
        function populateFontSizeOptions() {
            for (let i = 8; i <= 36; i += 2) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + 'px';
                fontSizeSelect.appendChild(option);
            }
        }
    
        // 加载模板元数据 (更新：分离文本模板)
        async function loadTemplateMetadata() {
          try {
            const response = await fetch(`/${state.repoName}/templates/metadata.json`);
            const data = await response.json();
            let templates = data.templates;

            // 1. 将内置文本模板添加到文本模板列表
            state.allTextTemplates = [TEXT_TEMPLATE_META];
            
            // 2. 过滤普通模板列表，确保 text-template 不在其中
            state.allTemplates = templates.filter(t => t.id !== TEXT_TEMPLATE_ID); 

            renderTemplateList(state.allTemplates);
            renderTextTemplateList(state.allTextTemplates);
          } catch (error) {
            // 如果远程加载失败，只显示内置文本模板
            state.allTextTemplates = [TEXT_TEMPLATE_META];
            state.allTemplates = [];
            renderTemplateList(state.allTemplates);
            renderTextTemplateList(state.allTextTemplates);
            console.error('模板元数据加载失败，仅显示内置文本模板：', error);
          }
        }
        
        // 渲染文本模板列表
        function renderTextTemplateList(templates) {
            if (templates.length === 0) {
                textListEl.innerHTML = '<div class="text-center text-gray-500 py-10">无文本模板数据</div>';
                return;
            }

            textListEl.innerHTML = templates.map(template => {
                // 文本模板卡片样式
                return `
                    <div class="template-card border-blue-300 bg-blue-50" data-id="${template.id}">
                        <div class="aspect-[4/3] bg-blue-100 flex items-center justify-center rounded overflow-hidden mb-2">
                            <i class="fa fa-font text-blue-600 text-3xl"></i>
                        </div>
                        <h3 class="text-sm font-medium text-gray-800">${template.name}</h3>
                        <p class="text-xs text-gray-500">${template.description}</p>
                    </div>
                `;
            }).join('');
        }
    
        // 渲染普通模板列表
        function renderTemplateList(templates) {
          if (templates.length === 0) {
            templateListEl.innerHTML = '<div class="text-center text-gray-500 py-10">无合规模板数据</div>';
            return;
          }
    
          templateListEl.innerHTML = templates.map(template => {
            return `
                <div class="template-card" data-id="${template.id}">
                    <div class="aspect-[4/3] bg-gray-100 rounded overflow-hidden mb-2">
                        <img src="${template.thumbnail.replace('./', `/${state.repoName}/`)}" alt="${template.name}" class="w-full h-full object-cover">
                    </div>
                    <h3 class="text-sm font-medium text-gray-800">${template.name}</h3>
                    <p class="text-xs text-gray-500">${template.description}</p>
                    <p class="text-xs text-gray-400 mt-1">${template.size.width}×${template.size.height}${template.size.unit}</p>
                </div>
            `;
          }).join('');
        }
        
        // 加载标志资源 (保持不变)
        async function loadAllAssets() {
          try {
            const allAssets = [];
            
            for (const category of assetCategories) {
              for (let i = 1; i <= 10; i++) {
                const src = `/${state.repoName}/assets/images/${category}/${category}${i}.jpg`;
                const asset = {
                  id: `${category}-${i}`,
                  category,
                  name: `${category}${i}`,
                  src: src
                };
                const exists = await checkImageExists(src);
                if (exists) {
                  allAssets.push(asset);
                } else {
                  break;
                }
              }
            }
            
            state.allAssets = allAssets;
            state.filteredAssets = allAssets;
            renderAssetList(allAssets);
          } catch (error) {
            assetListEl.innerHTML = '<div class="text-center text-red-500 py-10">标志加载失败</div>';
            console.error('标志资源加载失败：', error);
          }
        }
    
        // 检查图片是否存在 (保持不变)
        function checkImageExists(src) {
          return new Promise(resolve => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = src;
          });
        }
    
        // 渲染标志列表 (保持不变)
        function renderAssetList(assets) {
          if (assets.length === 0) {
            assetListEl.innerHTML = '<div class="text-center text-gray-500 py-10">无标志数据</div>';
            return;
          }
    
          const assetsByCategory = {};
          assets.forEach(asset => {
            if (!assetsByCategory[asset.category]) {
              assetsByCategory[asset.category] = [];
            }
            assetsByCategory[asset.category].push(asset);
          });
    
          let html = '';
          for (const category in assetsByCategory) {
            html += `
              <div class="mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">${category}</h3>
                <div class="grid grid-cols-2 gap-2">
                  ${assetsByCategory[category].map(asset => {
                      return `
                        <div class="asset-card" data-id="${asset.id}" data-type="image" data-src="${asset.src}" data-category="${asset.category}">
                            <div class="bg-gray-100 rounded overflow-hidden aspect-square">
                                <img src="${asset.src}" alt="${asset.name}" class="w-full h-full object-contain p-1">
                            </div>
                            <p class="text-xs text-center mt-1 text-gray-600">${asset.name}</p>
                        </div>
                      `;
                  }).join('')}
                </div>
              </div>
            `;
          }
          assetListEl.innerHTML = html;
        }
    
        // 添加标志到画布 (保持不变)
        function addAssetToCanvas(src) {
          if (canvas.children.length > 0 && canvas.children[0].classList.contains('justify-center')) {
            canvas.innerHTML = '';
          }
          
          const elementId = `asset-${Date.now()}`;
          const wrapper = document.createElement('div');
          wrapper.id = elementId;
          wrapper.className = 'canvas-element selected'; 
          wrapper.dataset.type = 'image-wrapper';
          
          const img = document.createElement('img');
          img.src = src;
          img.alt = '合规标志';
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/100?text=标志缺失';
          };
          
          const handles = ['tl', 'tr', 'bl', 'br'];
          handles.forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${pos}`;
            wrapper.appendChild(handle);
          });
          
          wrapper.appendChild(img);
    
          const defaultSizeMm = 50;
          const canvasWidth = parseFloat(canvasContainer.style.width);
          const canvasHeight = parseFloat(canvasContainer.style.height);
          
          wrapper.style.left = `${(canvasWidth - defaultSizeMm) / 2}mm`;
          wrapper.style.top = `${(canvasHeight - defaultSizeMm) / 2}mm`;
          wrapper.style.width = `${defaultSizeMm}mm`;
          wrapper.style.height = `${defaultSizeMm}mm`;
          
          canvas.appendChild(wrapper);
    
          document.querySelectorAll('.canvas-element').forEach(el => {
            if (el !== wrapper) el.classList.remove('selected');
          });
          
          wrapper.classList.add('selected');
          setupInteractForElement(wrapper); 
          showPropertyPanel(null); 
        }
    
        // 渲染模板元素 (保持不变)
        function renderTemplateElements(elements) {
          canvas.innerHTML = '';
          showPropertyPanel(null); 
          
          let firstElement = null;

          elements.forEach((element, index) => {
            const elementId = `element-${index}-${Date.now()}`;
            let domElement;
            
            switch (element.type) {
              case 'rect':
                domElement = createRectElement(elementId, element);
                break;
              case 'text':
                domElement = createTextElement(elementId, element);
                break;
              case 'image':
                domElement = createImageElement(elementId, element);
                break;
            }
            
            if (domElement) {
              canvas.appendChild(domElement);
              if (element.type === 'image' || element.type === 'rect' || element.type === 'text') { 
                setupInteractForElement(domElement); 
              }
              domElement.setAttribute('data-x', domElement.offsetLeft);
              domElement.setAttribute('data-y', domElement.offsetTop);

              if (!firstElement) {
                firstElement = domElement; 
              }
            }
          });
          
          if (firstElement) {
              document.querySelectorAll('.canvas-element').forEach(el => el.classList.remove('selected'));
              firstElement.classList.add('selected');
              showPropertyPanel(firstElement);
          }
        }
    
        // 创建元素工具函数 (保持不变)
        function createRectElement(id, element) {
          const div = document.createElement('div');
          div.id = id;
          div.className = 'canvas-element';
          div.dataset.type = 'rect';
          
          div.style.left = `${element.position.x}mm`;
          div.style.top = `${element.position.y}mm`;
          div.style.width = `${element.size.width}mm`;
          div.style.height = `${element.size.height}mm`;
          div.style.backgroundColor = element.style.fill || 'transparent';
          div.style.border = `${element.style.strokeWidth || 1}px solid ${element.style.stroke || '#ddd'}`;

          const handles = ['tl', 'tr', 'bl', 'br'];
          handles.forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${pos}`;
            div.appendChild(handle);
          });
          
          return div;
        }
    
        function createTextElement(id, element) {
          const div = document.createElement('div');
          div.id = id;
          div.className = 'canvas-element';
          div.dataset.type = 'text';
          
          div.style.left = `${element.position.x}mm`;
          div.style.top = `${element.position.y}mm`;
          div.style.fontSize = `${element.style.fontSize || 12}px`;
          div.style.fontWeight = element.style.fontWeight || 'normal';
          div.style.color = element.style.color || '#333';
          div.style.whiteSpace = 'nowrap';
          if (element.style.textAlign) div.style.textAlign = element.style.textAlign;
          
          div.innerText = element.content;
          if (element.editable) {
            div.contentEditable = true;
            div.classList.add('editable');
            div.setAttribute('title', '拖动移动，双击编辑');
          }
          
          return div;
        }
    
        function createImageElement(id, element) {
          const wrapper = document.createElement('div');
          wrapper.id = id;
          wrapper.className = 'canvas-element';
          wrapper.dataset.type = 'image-wrapper'; 
          
          const img = document.createElement('img');
          img.src = element.src.replace('./', `/${state.repoName}/`);
          img.alt = '合规标志';
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/60?text=标志缺失';
          };
          
          wrapper.style.left = `${element.position.x}mm`;
          wrapper.style.top = `${element.position.y}mm`;
          wrapper.style.width = `${element.size.width}mm`;
          wrapper.style.height = `${element.size.height}mm`;
    
          const handles = ['tl', 'tr', 'bl', 'br'];
          handles.forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${pos}`;
            wrapper.appendChild(handle);
          });
          
          wrapper.appendChild(img);
          
          return wrapper; 
        }
    
        // 初始化interact.js交互 (保持不变)
        function initInteractJs() {
          interact('.canvas-element')
            .draggable({
              inertia: true, 
              modifiers: [
                interact.modifiers.restrictRect({
                  restriction: 'parent', 
                  endOnly: true
                })
              ],
              autoScroll: true,
              ignoreFrom: '.resize-handle', 
              listeners: {
                move(event) {
                  const target = event.target;
                  let x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                  let y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
    
                  const mmX = x * PX_TO_MM;
                  const mmY = y * PX_TO_MM;
    
                  target.style.left = `${mmX}mm`;
                  target.style.top = `${mmY}mm`;
    
                  target.setAttribute('data-x', x);
                  target.setAttribute('data-y', y);
                }
              }
            })
            .on('down', function(event) {
              const target = event.target.closest('.canvas-element'); 
              
              if (!target) {
                showPropertyPanel(null); 
                return;
              }
    
              document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
                el.removeAttribute('data-x'); 
                el.removeAttribute('data-y');
              });
              
              target.classList.add('selected');
              
              target.setAttribute('data-x', target.offsetLeft);
              target.setAttribute('data-y', target.offsetTop);

              showPropertyPanel(target); 
            });
    
          interact('#canvas').on('down', function(event) {
            if (event.target === canvas) {
              document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
              });
              showPropertyPanel(null); 
            }
          });
        }
    
        // 为单个元素设置缩放功能 (保持不变)
        function setupInteractForElement(element, enableResize = true) {
          if ((element.dataset.type === 'image-wrapper' || element.dataset.type === 'rect') && enableResize) {
            interact(element).resizable({
              inertia: true,
              modifiers: [
                interact.modifiers.restrictSize({
                  min: { width: 10, height: 10 }
                }),
                interact.modifiers.restrictRect({
                  restriction: 'parent', 
                  endOnly: true
                })
              ],
              edges: { 
                left: '.resize-handle-tl, .resize-handle-bl', 
                right: '.resize-handle-tr, .resize-handle-br', 
                bottom: '.resize-handle-bl, .resize-handle-br', 
                top: '.resize-handle-tl, .resize-handle-tr' 
              },
              listeners: {
                move(event) {
                  const target = event.target;
                  
                  let x = (parseFloat(target.getAttribute('data-x')) || 0);
                  let y = (parseFloat(target.getAttribute('data-y')) || 0);
                  
                  x += event.deltaRect.left;
                  y += event.deltaRect.top;
    
                  const mmWidth = event.rect.width * PX_TO_MM;
                  const mmHeight = event.rect.height * PX_TO_MM;
                  const mmX = x * PX_TO_MM;
                  const mmY = y * PX_TO_MM;
                  
                  target.style.width = `${mmWidth}mm`;
                  target.style.height = `${mmHeight}mm`;
                  target.style.left = `${mmX}mm`;
                  target.style.top = `${mmY}mm`;
    
                  target.setAttribute('data-x', x);
                  target.setAttribute('data-y', y);
                }
              }
            });
          }
        }
        
        // 显示/隐藏属性面板，并绑定选中元素 (保持不变)
        function showPropertyPanel(element) {
            if (element && element.dataset.type === 'text') {
                selectedTextElement = element;
                const currentSize = parseFloat(element.style.fontSize) || 12;
                fontSizeSelect.value = currentSize;
                propertyPanel.classList.remove('hidden');
            } else {
                selectedTextElement = null;
                propertyPanel.classList.add('hidden');
            }
        }

        // 更新文本属性（字号） (保持不变)
        function updateTextProperties() {
            if (selectedTextElement) {
                const newSize = fontSizeSelect.value;
                selectedTextElement.style.fontSize = `${newSize}px`;
            }
        }
    
        // 加载模板到画布 (已修复 templateMeta.path 检查)
        async function loadTemplateToCanvas(templateId) {
            // 在普通模板和文本模板中查找元数据
            let templateMeta = state.allTemplates.find(t => t.id === templateId);
            if (!templateMeta) {
                templateMeta = state.allTextTemplates.find(t => t.id === templateId);
            }

            if (!templateMeta) return;
            
            // 修复: 检查 path 属性是否存在，避免 'replace' on undefined 错误
            if (!templateMeta.path) {
                alert(`模板 [${templateId}] 的元数据缺少文件路径 (path 属性)。请检查 metadata.json 文件结构。`);
                console.error(`Error: Template [${templateId}] metadata is missing the 'path' property.`, templateMeta);
                return;
            }

            let templateData;

            // 1. Fetch template data from the path
            try {
                const fetchPath = templateMeta.path.replace('./', `/${state.repoName}/`);
                const response = await fetch(fetchPath);
                if (!response.ok) {
                    throw new Error(`Failed to fetch ${templateMeta.path}: ${response.statusText}`);
                }
                templateData = await response.json();
            } catch (error) {
                // 如果 fetch 失败，或者 JSON 解析失败，会进入这里
                alert('加载模板详情失败，请检查文件路径（例如：templates/text.json）或网络连接。');
                console.error('加载模板详情失败:', error);
                return;
            }

            // 2. 设置画布尺寸
            const canvasWidthMm = templateMeta.size.width;
            const canvasHeightMm = templateMeta.size.height;
            canvasWidthInput.value = canvasWidthMm;
            canvasHeightInput.value = canvasHeightMm;
            applyCanvasSize();
            
            let elementsToRender = templateData.elements;

            // 3. 应用居中逻辑（仅针对内置文本框模板）
            if (templateId === TEXT_TEMPLATE_ID && elementsToRender.length > 0) {
                const defaultTextWidthMm = 100;
                const defaultTextHeightMm = 20;

                const centerX = canvasWidthMm / 2 - defaultTextWidthMm / 2;
                const centerY = canvasHeightMm / 2 - defaultTextHeightMm / 2;

                elementsToRender = elementsToRender.map(el => ({
                    ...el,
                    position: { 
                        x: centerX, 
                        y: centerY 
                    }
                }));
            }
            
            // 4. 清空画布并渲染元素
            renderTemplateElements(elementsToRender); 

            // 5. 选中当前模板卡片 (在两个列表中查找)
            document.querySelectorAll('.template-card').forEach(card => card.classList.remove('active'));
            // 确保只选中当前可见卡片
            const activeCard = document.querySelector(`#templateLibrary .template-card[data-id="${templateId}"], #textLibrary .template-card[data-id="${templateId}"]`);
            if (activeCard) {
                activeCard.classList.add('active');
            }
        }

        // 画布尺寸调整 (保持不变)
        function applyCanvasSize() {
          const width = parseInt(canvasWidthInput.value) || 210;
          const height = parseInt(canvasHeightInput.value) || 148;
          canvasContainer.style.width = `${width}mm`;
          canvasContainer.style.height = `${height}mm`;
        }
    
        // 删除选中元素的功能函数 (保持不变)
        function deleteSelectedElement() {
          const selectedElement = document.querySelector('.canvas-element.selected');
          
          if (selectedElement) {
            selectedElement.remove();
            showPropertyPanel(null); 
            
            if (canvas.children.length === 0) {
                canvas.innerHTML = `
                  <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">
                    请从左侧选择模板或标志添加到画布
                  </div>
                `;
            }
          }
        }
    
        // 导出功能 (保持不变)
        function exportCanvas(format) {
          if (canvas.children.length === 0 || canvas.querySelector('.text-gray-400')) {
            alert('请先选择并填写合规面单信息');
            return;
          }
          
          document.querySelectorAll('.canvas-element').forEach(el => {
            el.classList.remove('selected');
          });
          showPropertyPanel(null); 
    
          html2canvas(canvas, {
            scale: 2,
            useCORS: true
          }).then(canvasImage => {
            const imgData = canvasImage.toDataURL('image/png');
            
            if (format === 'pdf') {
              const { jsPDF } = window.jspdf;
              const pdf = new jsPDF({
                orientation: canvasWidthInput.value > canvasHeightInput.value ? 'l' : 'p',
                unit: 'mm',
                format: [parseInt(canvasWidthInput.value), parseInt(canvasHeightInput.value)]
              });
              pdf.addImage(imgData, 'PNG', 0, 0, parseInt(canvasWidthInput.value), parseInt(canvasHeightInput.value));
              pdf.save('跨境物流合规面单.pdf');
            } else {
              const link = document.createElement('a');
              link.download = `跨境物流合规面单.${format}`;
              link.href = format === 'jpg' ? imgData.replace('image/png', 'image/jpeg') : imgData;
              link.click();
            }
          });
        }
    
        // 筛选标志 (保持不变)
        function filterAssets() {
          const keyword = assetSearchInput.value.toLowerCase();
          let filtered = state.allAssets;
          
          if (state.currentCategory !== 'all') {
            filtered = filtered.filter(asset => asset.category === state.currentCategory);
          }
          
          if (keyword) {
            filtered = filtered.filter(asset => 
              asset.name.toLowerCase().includes(keyword) || 
              asset.category.toLowerCase().includes(keyword)
            );
          }
          
          state.filteredAssets = filtered;
          renderAssetList(filtered);
        }
    
        // 事件监听
        function initEventListeners() {
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' || e.key === 'Backspace') {
              const focusedElement = document.activeElement;
              const isInputFocused = (focusedElement.tagName === 'INPUT' || focusedElement.tagName === 'TEXTAREA');
              const isEditable = focusedElement.hasAttribute('contenteditable') && focusedElement.getAttribute('contenteditable') === 'true';
    
              if (!isInputFocused && !isEditable) {
                e.preventDefault();
                deleteSelectedElement();
              }
            }
          });
          
          fontSizeSelect.addEventListener('change', updateTextProperties);
          
          document.addEventListener('click', (e) => {
            if (!e.target.closest('#canvas') && !e.target.closest('#propertyPanel')) {
                if (!document.querySelector('.canvas-element.selected')) {
                    showPropertyPanel(null); 
                }
            }
          });
    
          // 标签页切换逻辑
          const switchTab = (activeTab, activeLibrary) => {
            const tabs = [templateTab, textTab, assetTab];
            const libraries = [templateLibrary, textLibrary, assetLibrary];
            
            tabs.forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                tab.classList.add('text-gray-500', 'hover:text-gray-700');
            });
            libraries.forEach(lib => lib.classList.add('hidden'));

            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            activeTab.classList.remove('text-gray-500', 'hover:text-gray-700');
            activeLibrary.classList.remove('hidden');
          };
          
          templateTab.addEventListener('click', () => switchTab(templateTab, templateLibrary));
          textTab.addEventListener('click', () => switchTab(textTab, textLibrary));
          assetTab.addEventListener('click', () => switchTab(assetTab, assetLibrary));
    
          // 模板搜索
          templateSearchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = state.allTemplates.filter(t => 
              t.name.toLowerCase().includes(keyword) || 
              t.description.toLowerCase().includes(keyword)
            );
            renderTemplateList(filtered);
          });
    
          // 模板库点击 (普通模板)
          templateListEl.addEventListener('click', (e) => {
            const card = e.target.closest('.template-card');
            if (card) {
              const templateId = card.getAttribute('data-id');
              loadTemplateToCanvas(templateId);
            }
          });

          // 文本库点击
          textListEl.addEventListener('click', (e) => {
            const card = e.target.closest('.template-card');
            if (card) {
              const templateId = card.getAttribute('data-id');
              loadTemplateToCanvas(templateId);
            }
          });
    
          // 标志分类筛选
          document.querySelectorAll('.asset-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              document.querySelectorAll('.asset-category-btn').forEach(b => {
                b.classList.remove('bg-blue-500', 'text-white');
                b.classList.add('text-gray-600', 'hover:bg-gray-100');
              });
              e.target.classList.add('bg-blue-500', 'text-white');
              e.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
              
              state.currentCategory = e.target.getAttribute('data-category');
              filterAssets();
            });
          });
    
          // 标志搜索
          assetSearchInput.addEventListener('input', filterAssets);
    
          // 标志点击添加
          assetListEl.addEventListener('click', (e) => {
            const card = e.target.closest('.asset-card');
            if (card && card.getAttribute('data-type') === 'image') {
              const src = card.getAttribute('data-src');
              addAssetToCanvas(src);
            }
          });
    
          // 画布尺寸应用
          applySizeBtn.addEventListener('click', applyCanvasSize);
    
          // 导出按钮
          exportBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportOptions.classList.toggle('hidden');
          });
    
          document.addEventListener('click', () => {
            exportOptions.classList.add('hidden');
          });
    
          exportOptions.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const format = btn.getAttribute('data-format');
              exportCanvas(format);
              exportOptions.classList.add('hidden');
            });
          });
        }
    
        // 启动
        window.addEventListener('DOMContentLoaded', init);
      </script>

</body>
</html>
