<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>跨境电商物流合规面单编辑器</title>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .template-card {
        @apply border border-gray-200 rounded-md p-2 mb-3 cursor-pointer hover:bg-gray-50 transition-all;
      }
      .template-card.active {
        @apply border-blue-500 bg-blue-50;
      }
      .asset-card {
        @apply border border-gray-200 rounded-md p-2 mb-2 cursor-pointer hover:bg-gray-50 transition-all;
      }
      /* 新增的文本库卡片样式 */
      .text-action-card {
        @apply border border-dashed border-gray-300 rounded-lg p-4 mb-3 text-center cursor-pointer hover:bg-gray-50 transition-all;
      }
      .canvas-container {
        @apply border border-gray-300 rounded-md bg-white relative overflow-hidden;
      }
      .canvas-element {
        @apply absolute select-none;
      }
      .editable {
        /* 新增内边距和行高设置，确保文本在容器内居中且易于编辑 */
        @apply cursor-text outline-none p-1 inline-block h-full w-full leading-normal; 
      }
      /* 缩放手柄样式 */
      .resize-handle {
        /* *** 修复: 提高 z-index 确保手柄位于文本元素之上 *** */
        @apply absolute w-4 h-4 bg-blue-500 rounded-full border border-white shadow-md z-20 hidden; 
      }
      /* 选中时显示手柄 */
      .selected .resize-handle {
        @apply block;
      }
      .resize-handle-tl { top: -6px; left: -6px; cursor: nwse-resize; }
      .resize-handle-tr { top: -6px; right: -6px; cursor: nesw-resize; }
      .resize-handle-bl { bottom: -6px; left: -6px; cursor: nesw-resize; }
      .resize-handle-br { bottom: -6px; right: -6px; cursor: nwse-resize; }
      
      /* 选中元素轮廓 */
      .canvas-element.selected {
        @apply outline outline-2 outline-blue-500;
      }
      
      /* 确保图片元素在容器内显示 */
      .canvas-element img {
        display: block;
        max-width: 100%;
        max-height: 100%;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      /* 确保文本元素容器能控制文本流 */
      .canvas-element[data-type="text-wrapper"] {
        @apply overflow-hidden;
      }
    }
  </style>
</head>
<body class="flex h-screen bg-gray-100 overflow-hidden">

  <div class="w-16 flex flex-col items-center py-4 border-r border-gray-200 bg-white">
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-paint-brush text-xl mb-1"></i>
      <span class="text-xs">绘制</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-blue-600 transition-colors">
      <i class="fa fa-font text-xl mb-1"></i>
      <span class="text-xs">文字</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-square-o text-xl mb-1"></i>
      <span class="text-xs">形状</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors"> 
      <i class="fa fa-picture-o text-xl mb-1"></i>
      <span class="text-xs">标志</span>
    </button>
    <button class="flex flex-col items-center text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-th-large text-xl mb-1"></i>
      <span class="text-xs">模板</span>
    </button>
  </div>

  <div class="w-72 border-r border-gray-200 flex flex-col bg-white">
    <div class="border-b border-gray-200">
      <div class="flex">
        <button id="templateTab" class="flex-1 py-3 text-center text-sm font-medium text-gray-500 hover:text-gray-700">
          模板库
        </button>
        <button id="textTab" class="flex-1 py-3 text-center text-sm font-medium text-gray-500 hover:text-gray-700">
          文本库
        </button>
        <button id="assetTab" class="flex-1 py-3 text-center text-sm font-medium text-gray-500 hover:text-gray-700">
          标志库
        </button>
      </div>
    </div>

    <div id="templateLibrary" class="hidden flex-1 overflow-y-auto scrollbar-hide p-3">
      <div class="mb-4">
        <input type="text" id="templateSearch" placeholder="搜索合规模板" 
               class="w-full px-3 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        <div class="flex mt-2 space-x-1">
          <button class="template-category-btn px-3 py-1 bg-blue-500 text-white rounded-md text-sm" data-category="all">全部</button>
          <button class="template-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="物流">物流</button>
          <button class="template-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="文本">文本</button>
        </div>
      </div>
      <div id="templateList" class="space-y-2">
        <div class="text-center text-gray-500 py-10">加载模板中...</div>
      </div>
    </div>
    
    <div id="textLibrary" class="hidden flex-1 overflow-y-auto scrollbar-hide p-3">
      <div id="addBlankTextCard" class="text-action-card">
        <i class="fa fa-plus text-2xl text-blue-500 mb-2"></i>
        <p class="text-sm font-medium text-gray-700">添加空白文本框</p>
        <p class="text-xs text-gray-500">可自由编辑和缩放</p>
      </div>
      
      <h3 class="text-sm font-medium text-gray-700 mb-2 mt-4">常用预设文本</h3>
      <div id="textTemplateList" class="space-y-2">
        <div class="text-center text-gray-500 py-10">加载文本模板中...</div>
      </div>
    </div>

    <div id="assetLibrary" class="hidden flex-1 overflow-y-auto scrollbar-hide p-3">
      <div class="mb-4">
        <input type="text" id="assetSearch" placeholder="搜索标志（如：窒息警告）" 
               class="w-full px-3 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        
        <div class="mt-3 overflow-x-auto scrollbar-hide">
          <div class="flex space-x-2 pb-2 min-w-max">
            <button class="asset-category-btn px-3 py-1 bg-blue-500 text-white rounded-md text-sm" data-category="all">
              全部
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="代理">
              代理
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="法国标">
              法国标
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="化妆品">
              化妆品
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="能效">
              能效
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="纽扣电池">
              纽扣电池
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="西班牙回收">
              西班牙回收
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="窒息警告">
              窒息警告
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="其他">
              其他
            </button>
          </div>
        </div>
      </div>

      <div id="assetList" class="space-y-3">
        <div class="text-center text-gray-500 py-10">加载标志中...</div>
      </div>
    </div>
  </div>

  <div class="flex-1 flex flex-col overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
      <div class="text-sm text-gray-500 flex items-center">
        <i class="fa fa-info-circle mr-1"></i>
        <span>合规面单请确保所有信息完整，标志位置正确</span>
      </div>
      <div class="flex items-center">
        <span class="text-sm mr-2">画布尺寸:</span>
        <input type="number" id="canvasWidth" value="210" min="50" max="500" 
               class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
        <span class="mx-1">×</span>
        <input type="number" id="canvasHeight" value="148" min="50" max="500" 
               class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
        <span class="ml-1 mr-3">mm</span>
        <button id="applySizeBtn" class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">应用</button>
      </div>
    </div>
    
    <div class="flex-1 p-6 overflow-auto bg-gray-50">
      <div class="max-w-4xl mx-auto">
        <div id="canvasContainer" class="canvas-container mx-auto transition-all duration-300" 
             style="width: 210mm; height: 148mm;">
          <div id="canvas" class="w-full h-full relative">
            <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">
              请从左侧选择模板或标志添加到画布
            </div>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end">
          <div class="relative inline-block">
            <button id="exportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
              导出合规面单 <i class="fa fa-download ml-1"></i>
            </button>
            <div id="exportOptions" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
              <button data-format="pdf" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-pdf-o mr-2 text-red-500"></i>PDF格式（推荐）
              </button>
              <button data-format="png" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-image-o mr-2 text-green-500"></i>PNG格式
              </button>
              <button data-format="jpg" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-image-o mr-2 text-yellow-500"></i>JPG格式
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


    <script>
        const state = {
          currentTemplate: null,
          allTemplates: [],
          allAssets: [],
          filteredAssets: [],
          currentCategory: 'all',
          repoName: 'miandan' // 你的仓库名称
        };
    
        const assetCategories = [
          '代理', '法国标', '化妆品', '能效', 
          '纽扣电池', '西班牙回收', '窒息警告', '其他'
        ];
        
        const TEXT_TEMPLATE_ID = 'text-pre'; // 预设文本模板ID
    
        // DOM元素
        const canvas = document.getElementById('canvas');
        const canvasContainer = document.getElementById('canvasContainer');
        const canvasWidthInput = document.getElementById('canvasWidth');
        const canvasHeightInput = document.getElementById('canvasHeight');
        const applySizeBtn = document.getElementById('applySizeBtn');
        const exportBtn = document.getElementById('exportBtn');
        const exportOptions = document.getElementById('exportOptions');
        const templateListEl = document.getElementById('templateList');
        const templateSearchInput = document.getElementById('templateSearch');
        const assetListEl = document.getElementById('assetList');
        const assetSearchInput = document.getElementById('assetSearch');
        
        // <<< 新增文本库相关DOM元素 >>>
        const textTemplateListEl = document.getElementById('textTemplateList');
        const addBlankTextCard = document.getElementById('addBlankTextCard');
        // <<< 标签页DOM元素更新 >>>
        const templateTab = document.getElementById('templateTab');
        const assetTab = document.getElementById('assetTab');
        const textTab = document.getElementById('textTab'); 
        const templateLibrary = document.getElementById('templateLibrary');
        const assetLibrary = document.getElementById('assetLibrary');
        const textLibrary = document.getElementById('textLibrary'); 
    
        // 像素到毫米的转换因子 (1px ≈ 0.264583mm, 1mm ≈ 3.779528px)
        const MM_TO_PX = 3.779528;
        const PX_TO_MM = 0.264583;
    
        // 初始化
        async function init() {
          await Promise.all([
            loadTemplateMetadata(),
            loadAllAssets()
          ]);
          initEventListeners();
          initInteractJs(); // 初始化interact.js
          switchTab('textTab'); // 默认激活文本库
        }
    
        // 加载模板元数据 (使用用户提供的模拟数据)
        async function loadTemplateMetadata() {
          try {
            // 使用用户提供的 mock metadata.json 数据
            const mockData = {
                "templates": [
                    {
                        "id": "sender-info",
                        "name": "寄件人合规面单",
                        "category": "物流",
                        "thumbnail": "./assets/thumbnails/sender-info.jpg",
                        "description": "包含寄件人信息、收件人信息及跨境物流警示",
                        "size": { "width": 100, "height": 100, "unit": "mm" }
                    },
                    {
                        "id": "text-pre",
                        "name": "预文本",
                        "category": "文本",
                        "thumbnail": "./assets/thumbnails/sender-info.jpg",
                        "description": "示例文本",
                        "size": { "width": 40, "height": 30, "unit": "mm" }
                    },
                    {
                        "id": "manufacturer-info",
                        "name": "制造商合规面单",
                        "category": "物流",
                        "thumbnail": "./assets/thumbnails/manufacturer-info.jpg",
                        "description": "包含制造商信息、欧盟代表及产品合规标识",
                        "size": { "width": 70, "height": 70, "unit": "mm" }
                    }
                ]
            };

            const data = mockData; 
            state.allTemplates = data.templates;
            renderTemplateList(data.templates);
            renderTextLibrary(); // 渲染文本模板
          } catch (error) {
            templateListEl.innerHTML = '<div class="text-center text-red-500 py-10">模板加载失败</div>';
            console.error('模板元数据加载失败：', error);
          }
        }
    
        // 加载标志资源 (保持不变)
        async function loadAllAssets() {
          try {
            const allAssets = [];
            for (const category of assetCategories) {
              for (let i = 1; i <= 10; i++) {
                const src = `/${state.repoName}/assets/images/${category}/${category}${i}.jpg`;
                const asset = {
                  id: `${category}-${i}`,
                  category,
                  name: `${category}${i}`,
                  src: src
                };
                const exists = await checkImageExists(src);
                if (exists) {
                  allAssets.push(asset);
                } else {
                  break;
                }
              }
            }
            state.allAssets = allAssets;
            state.filteredAssets = allAssets;
            renderAssetList(allAssets);
          } catch (error) {
            assetListEl.innerHTML = '<div class="text-center text-red-500 py-10">标志加载失败</div>';
            console.error('标志资源加载失败：', error);
          }
        }
    
        // 检查图片是否存在 (保持不变)
        function checkImageExists(src) {
          return new Promise(resolve => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = src;
          });
        }
    
        // 渲染模板列表 (保持不变)
        function renderTemplateList(templates) {
          if (templates.length === 0) {
            templateListEl.innerHTML = '<div class="text-center text-gray-500 py-10">无合规模板数据</div>';
            return;
          }
    
          templateListEl.innerHTML = templates
            .filter(t => t.id !== TEXT_TEMPLATE_ID) // 文本模板在另一处渲染
            .map(template => `
            <div class="template-card" data-id="${template.id}">
              <div class="aspect-[4/3] bg-gray-100 rounded overflow-hidden mb-2">
                <img src="${template.thumbnail.replace('./', `/${state.repoName}/`)}" alt="${template.name}" class="w-full h-full object-cover">
              </div>
              <h3 class="text-sm font-medium text-gray-800">${template.name}</h3>
              <p class="text-xs text-gray-500">${template.description}</p>
              <p class="text-xs text-gray-400 mt-1">${template.size.width}×${template.size.height}${template.size.unit}</p>
            </div>
          `).join('');
        }
        
        // <<< 新增：渲染文本库 >>>
        function renderTextLibrary() {
            const textTemplate = state.allTemplates.find(t => t.id === TEXT_TEMPLATE_ID);
            
            if (textTemplate) {
                textTemplateListEl.innerHTML = `
                    <div class="template-card" data-id="${textTemplate.id}" data-template-type="text">
                        <div class="aspect-[4/3] bg-gray-100 rounded overflow-hidden mb-2 flex items-center justify-center">
                            <i class="fa fa-file-text-o text-5xl text-gray-400 p-4"></i>
                        </div>
                        <h3 class="text-sm font-medium text-gray-800">${textTemplate.name}</h3>
                        <p class="text-xs text-gray-500">${textTemplate.description}</p>
                        <p class="text-xs text-gray-400 mt-1">${textTemplate.size.width}×${textTemplate.size.height}${textTemplate.size.unit}</p>
                    </div>
                `;
            } else {
                textTemplateListEl.innerHTML = '<div class="text-center text-gray-500 py-10">无预设文本模板</div>';
            }
        }
    
        // 渲染标志列表 (保持不变)
        function renderAssetList(assets) {
          if (assets.length === 0) {
            assetListEl.innerHTML = '<div class="text-center text-gray-500 py-10">无标志数据</div>';
            return;
          }
    
          const assetsByCategory = {};
          assets.forEach(asset => {
            if (!assetsByCategory[asset.category]) {
              assetsByCategory[asset.category] = [];
            }
            assetsByCategory[asset.category].push(asset);
          });
    
          let html = '';
          for (const category in assetsByCategory) {
            html += `
              <div class="mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">${category}</h3>
                <div class="grid grid-cols-2 gap-2">
                  ${assetsByCategory[category].map(asset => `
                    <div class="asset-card" data-id="${asset.id}" data-src="${asset.src}" data-category="${asset.category}">
                      <div class="bg-gray-100 rounded overflow-hidden aspect-square">
                        <img src="${asset.src}" alt="${asset.name}" class="w-full h-full object-contain p-1">
                      </div>
                      <p class="text-xs text-center mt-1 text-gray-600">${asset.name}</p>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
          assetListEl.innerHTML = html;
        }
    
        // 加载模板到画布 (模拟模板内容)
        async function loadTemplateToCanvas(templateId) {
          canvas.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-400">加载中...</div>';
          
          try {
            document.querySelectorAll('.canvas-element').forEach(el => el.classList.remove('selected'));
            
            let template;
            if (templateId === TEXT_TEMPLATE_ID) {
                // 模拟 txt-pre.json 模板内容
                template = {
                    "elements": [
                        {
                            "type": "text",
                            "content": "预设文本：版权所有，违者必究。",
                            "position": { "x": 5, "y": 5 },
                            "size": { "width": 30, "height": 10 },
                            "style": { "fontSize": 12, "fontWeight": "bold", "color": "#7C3AED" },
                            "editable": true
                        }
                    ]
                };
            } else {
                // 模拟其他模板内容 (无法实际获取，使用通用结构)
                // const response = await fetch(`/${state.repoName}/templates/${templateId}.json`);
                // template = await response.json();
                template = {
                    "elements": [
                        {
                            "type": "rect",
                            "position": { "x": 0, "y": 0 },
                            "size": { "width": 100, "height": 100 },
                            "style": { "stroke": "#000", "strokeWidth": 1, "fill": "transparent" }
                        },
                        {
                            "type": "text",
                            "content": "寄件人/制造商信息 (模拟)",
                            "position": { "x": 5, "y": 5 },
                            "size": { "width": 90, "height": 10 },
                            "style": { "fontSize": 12, "color": "#000000" },
                            "editable": true
                        }
                    ]
                };
            }
            
            const templateMeta = state.allTemplates.find(t => t.id === templateId);
            if (templateMeta) {
              canvasWidthInput.value = templateMeta.size.width;
              canvasHeightInput.value = templateMeta.size.height;
              applyCanvasSize();
            }
            
            renderTemplateElements(template.elements);
            
            document.querySelectorAll('.template-card').forEach(card => {
              card.classList.toggle('active', card.getAttribute('data-id') === templateId);
            });
            state.currentTemplate = templateId;
    
          } catch (error) {
            canvas.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-red-500">模板加载失败</div>';
            console.error('模板加载失败：', error);
          }
        }
        
        // <<< 新增：添加空白文本框到画布 >>>
        function addBlankTextToCanvas() {
            if (canvas.children.length === 1 && canvas.children[0].classList.contains('justify-center')) {
                canvas.innerHTML = '';
            }
            
            const elementId = `text-${Date.now()}`;
            
            // 默认属性
            const defaultElement = {
                type: 'text',
                content: '双击此处编辑文本',
                position: { x: 0, y: 0 }, // 初始值，将被覆盖
                size: { width: 50, height: 10 },
                style: { fontSize: 16, fontWeight: 'normal', color: '#000000', textAlign: 'left' },
                editable: true
            };
            
            const domElement = createTextElement(elementId, defaultElement);
            
            // 默认位置和尺寸 (50mm x 10mm)
            const defaultWidth = 50;
            const defaultHeight = 10;
            const canvasWidth = parseFloat(canvasContainer.style.width.replace('mm', ''));
            const canvasHeight = parseFloat(canvasContainer.style.height.replace('mm', ''));
            
            // 居中设置
            domElement.style.left = `${(canvasWidth - defaultWidth) / 2}mm`;
            domElement.style.top = `${(canvasHeight - defaultHeight) / 2}mm`;
            domElement.style.width = `${defaultWidth}mm`;
            domElement.style.height = `${defaultHeight}mm`;
            
            canvas.appendChild(domElement); 
    
            // 激活选中状态
            document.querySelectorAll('.canvas-element').forEach(el => {
                if (el !== domElement) el.classList.remove('selected');
            });
            domElement.classList.add('selected');

            // 为新元素设置interact.js交互
            setupInteractForElement(domElement); 
        }

        // 添加标志到画布 (保持不变)
        function addAssetToCanvas(src) {
          if (canvas.children.length === 1 && canvas.children[0].classList.contains('justify-center')) {
            canvas.innerHTML = '';
          }
          
          const elementId = `asset-${Date.now()}`;
          
          const wrapper = document.createElement('div');
          wrapper.id = elementId;
          wrapper.className = 'canvas-element selected'; 
          wrapper.dataset.type = 'image-wrapper'; 
          
          const img = document.createElement('img');
          img.src = src;
          img.alt = '合规标志';
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/100?text=标志缺失';
          };
          
          // 添加缩放手柄到 wrapper
          const handles = ['tl', 'tr', 'bl', 'br'];
          handles.forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${pos}`;
            wrapper.appendChild(handle);
          });
          
          wrapper.appendChild(img); 
    
          // 默认位置和尺寸 (50mm x 50mm)
          const defaultSizeMm = 50;
          const canvasWidth = parseFloat(canvasContainer.style.width.replace('mm', ''));
          const canvasHeight = parseFloat(canvasContainer.style.height.replace('mm', ''));
          
          wrapper.style.left = `${(canvasWidth - defaultSizeMm) / 2}mm`;
          wrapper.style.top = `${(canvasHeight - defaultSizeMm) / 2}mm`;
          wrapper.style.width = `${defaultSizeMm}mm`;
          wrapper.style.height = `${defaultSizeMm}mm`;
          
          canvas.appendChild(wrapper); 
    
          // 激活选中状态
          document.querySelectorAll('.canvas-element').forEach(el => {
            if (el !== wrapper) el.classList.remove('selected');
          });
          
          // 为新元素设置interact.js交互
          setupInteractForElement(wrapper); 
        }
    
        // 渲染模板元素 (更新以处理新的 text-wrapper)
        function renderTemplateElements(elements) {
          canvas.innerHTML = '';
          
          elements.forEach((element, index) => {
            const elementId = `element-${index}-${Date.now()}`;
            let domElement;
            
            switch (element.type) {
              case 'rect':
                domElement = createRectElement(elementId, element);
                break;
              case 'text':
                domElement = createTextElement(elementId, element); // 使用新的 createTextElement
                break;
              case 'image':
                domElement = createImageElement(elementId, element);
                break;
            }
            
            if (domElement) {
              canvas.appendChild(domElement);
              // 确保所有可操作元素都设置交互
              if (element.type === 'image' || element.type === 'rect' || element.type === 'text') { 
                setupInteractForElement(domElement); 
              }
            }
          });
        }
    
        // 创建矩形元素 (保持不变)
        function createRectElement(id, element) {
          const div = document.createElement('div');
          div.id = id;
          div.className = 'canvas-element';
          div.dataset.type = 'rect';
          
          div.style.left = `${element.position.x}mm`;
          div.style.top = `${element.position.y}mm`;
          div.style.width = `${element.size.width}mm`;
          div.style.height = `${element.size.height}mm`;
          div.style.backgroundColor = element.style.fill || 'transparent';
          div.style.border = `${element.style.strokeWidth || 1}px solid ${element.style.stroke || '#ddd'}`;

          const handles = ['tl', 'tr', 'bl', 'br'];
          handles.forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${pos}`;
            div.appendChild(handle);
          });
          
          return div;
        }
    
        // <<< 核心修改: 创建文本容器元素 (支持缩放和编辑) >>>
        function createTextElement(id, element) {
            // 创建外层容器（用于定位和缩放）
            const wrapper = document.createElement('div');
            wrapper.id = id;
            wrapper.className = 'canvas-element';
            wrapper.dataset.type = 'text-wrapper'; // 标记为文本容器
            
            // 添加缩放手柄到 wrapper
            const handles = ['tl', 'tr', 'bl', 'br'];
            handles.forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle resize-handle-${pos}`;
                wrapper.appendChild(handle);
            });
            
            // 创建实际的文本元素（用于显示和编辑）
            const textEl = document.createElement('span'); 
            textEl.className = 'editable'; // 使用新的 .editable 样式
            textEl.innerText = element.content;
            textEl.style.fontSize = `${element.style.fontSize || 12}px`;
            textEl.style.fontWeight = element.style.fontWeight || 'normal';
            textEl.style.color = element.style.color || '#333';
            textEl.style.whiteSpace = 'normal'; // 允许换行
            textEl.style.wordBreak = 'break-word'; // 处理长单词
            if (element.style.textAlign) textEl.style.textAlign = element.style.textAlign;
            
            if (element.editable) {
                textEl.contentEditable = true;
                textEl.setAttribute('title', '双击编辑');
            }
            
            // 应用尺寸和位置 (使用 size 和 position 属性)
            if (element.size) {
                wrapper.style.width = `${element.size.width}mm`;
                wrapper.style.height = `${element.size.height}mm`;
            }
            wrapper.style.left = `${element.position.x}mm`;
            wrapper.style.top = `${element.position.y}mm`;
            
            wrapper.appendChild(textEl);
            
            return wrapper;
        }
    
        // 创建图片容器元素 (保持不变)
        function createImageElement(id, element) {
          const wrapper = document.createElement('div');
          wrapper.id = id;
          wrapper.className = 'canvas-element';
          wrapper.dataset.type = 'image-wrapper'; 
          
          const img = document.createElement('img');
          img.src = element.src.replace('./', `/${state.repoName}/`);
          img.alt = '合规标志';
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/60?text=标志缺失';
          };
          
          wrapper.style.left = `${element.position.x}mm`;
          wrapper.style.top = `${element.position.y}mm`;
          wrapper.style.width = `${element.size.width}mm`;
          wrapper.style.height = `${element.size.height}mm`;
    
          const handles = ['tl', 'tr', 'bl', 'br'];
          handles.forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${pos}`;
            wrapper.appendChild(handle);
          });
          
          wrapper.appendChild(img);
          
          return wrapper; 
        }
    
        // 初始化interact.js交互（核心功能）
        function initInteractJs() {
          interact('.canvas-element')
            .draggable({
              inertia: true, 
              modifiers: [
                interact.modifiers.restrictRect({
                  restriction: 'parent', 
                  endOnly: true
                })
              ],
              autoScroll: true,
              // 忽略来自缩放手柄和可编辑文本span的拖拽事件
              ignoreFrom: '.resize-handle, [contenteditable="true"]', 
              listeners: {
                move(event) {
                  const target = event.target;
                  let x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                  let y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
    
                  const mmX = x * PX_TO_MM;
                  const mmY = y * PX_TO_MM;
    
                  target.style.left = `${mmX}mm`;
                  target.style.top = `${mmY}mm`;
    
                  target.setAttribute('data-x', x);
                  target.setAttribute('data-y', y);
                }
              }
            })
            .on('down', function(event) {
              const target = event.target.closest('.canvas-element'); 
              if (!target) return;
    
              document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
                el.removeAttribute('data-x');
                el.removeAttribute('data-y');
              });
              
              target.classList.add('selected');
              
              target.setAttribute('data-x', target.offsetLeft);
              target.setAttribute('data-y', target.offsetTop);
            });
    
          // 点击画布空白处取消选中
          interact('#canvas').on('down', function(event) {
            if (event.target === canvas) {
              document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
              });
            }
          });
        }
    
        // 为单个元素设置缩放功能
        function setupInteractForElement(element, enableResize = true) {
          // 启用 image-wrapper, rect, 和 text-wrapper 的缩放
          if ((element.dataset.type === 'image-wrapper' || element.dataset.type === 'rect' || element.dataset.type === 'text-wrapper') && enableResize) { 
            interact(element).resizable({
              inertia: true,
              modifiers: [
                interact.modifiers.restrictSize({
                  min: { width: 10, height: 10 } 
                }),
                interact.modifiers.restrictRect({
                  restriction: 'parent', 
                  endOnly: true
                })
              ],
              edges: { 
                left: '.resize-handle-tl, .resize-handle-bl', 
                right: '.resize-handle-tr, .resize-handle-br', 
                bottom: '.resize-handle-bl, .resize-handle-br', 
                top: '.resize-handle-tl, .resize-handle-tr' 
              },
              listeners: {
                move(event) {
                  const target = event.target; 
                  
                  let x = (parseFloat(target.getAttribute('data-x')) || 0);
                  let y = (parseFloat(target.getAttribute('data-y')) || 0);
                  
                  x += event.deltaRect.left;
                  y += event.deltaRect.top;
    
                  const mmWidth = event.rect.width * PX_TO_MM;
                  const mmHeight = event.rect.height * PX_TO_MM;
                  const mmX = x * PX_TO_MM;
                  const mmY = y * PX_TO_MM;
                  
                  target.style.width = `${mmWidth}mm`;
                  target.style.height = `${mmHeight}mm`;
                  target.style.left = `${mmX}mm`;
                  target.style.top = `${mmY}mm`;
    
                  target.setAttribute('data-x', x);
                  target.setAttribute('data-y', y);
                }
              }
            });
          }
        }
    
        // 画布尺寸调整 (保持不变)
        function applyCanvasSize() {
          const width = parseInt(canvasWidthInput.value) || 210;
          const height = parseInt(canvasHeightInput.value) || 148;
          canvasContainer.style.width = `${width}mm`;
          canvasContainer.style.height = `${height}mm`;
        }
    
        // 删除选中元素的功能函数 (保持不变)
        function deleteSelectedElement() {
          const selectedElement = document.querySelector('.canvas-element.selected');
          
          if (selectedElement) {
            selectedElement.remove();
            
            if (canvas.children.length === 0) {
                canvas.innerHTML = `
                  <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">
                    请从左侧选择模板或标志添加到画布
                  </div>
                `;
            }
          }
        }
    
        // 导出功能 (保持不变)
        function exportCanvas(format) {
          if (canvas.children.length === 0 || canvas.querySelector('.text-gray-400')) {
            alert('请先选择并填写合规面单信息');
            return;
          }
          
          document.querySelectorAll('.canvas-element').forEach(el => {
            el.classList.remove('selected');
          });
    
          html2canvas(canvas, {
            scale: 2, 
            useCORS: true 
          }).then(canvasImage => {
            const imgData = canvasImage.toDataURL('image/png');
            
            if (format === 'pdf') {
              const { jsPDF } = window.jspdf;
              const pdf = new jsPDF({
                orientation: canvasWidthInput.value > canvasHeightInput.value ? 'l' : 'p',
                unit: 'mm',
                format: [parseInt(canvasWidthInput.value), parseInt(canvasHeightInput.value)]
              });
              pdf.addImage(imgData, 'PNG', 0, 0, parseInt(canvasWidthInput.value), parseInt(canvasHeightInput.value));
              pdf.save('跨境物流合规面单.pdf');
            } else {
              const link = document.createElement('a');
              link.download = `跨境物流合规面单.${format}`;
              link.href = format === 'jpg' ? imgData.replace('image/png', 'image/jpeg') : imgData;
              link.click();
            }
          });
        }
    
        // 筛选标志 (保持不变)
        function filterAssets() {
          const keyword = assetSearchInput.value.toLowerCase();
          let filtered = state.allAssets;
          
          if (state.currentCategory !== 'all') {
            filtered = filtered.filter(asset => asset.category === state.currentCategory);
          }
          
          if (keyword) {
            filtered = filtered.filter(asset => 
              asset.name.toLowerCase().includes(keyword) || 
              asset.category.toLowerCase().includes(keyword)
            );
          }
          
          state.filteredAssets = filtered;
          renderAssetList(filtered);
        }
        
        // 标签页切换逻辑 (新增 textTab 处理)
        function switchTab(activeTabId) {
            const tabs = [
                { id: 'templateTab', library: templateLibrary },
                { id: 'textTab', library: textLibrary },
                { id: 'assetTab', library: assetLibrary }
            ];

            tabs.forEach(tab => {
                const button = document.getElementById(tab.id);
                if (tab.id === activeTabId) {
                    tab.library.classList.remove('hidden');
                    button.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                    button.classList.remove('text-gray-500', 'hover:text-gray-700');
                } else {
                    tab.library.classList.add('hidden');
                    button.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    button.classList.add('text-gray-500', 'hover:text-gray-700');
                }
            });
        }

    
        // 事件监听 (新增文本库事件)
        function initEventListeners() {
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' || e.key === 'Backspace') {
              const focusedElement = document.activeElement;
              const isInputFocused = (focusedElement.tagName === 'INPUT' || focusedElement.tagName === 'TEXTAREA');
              const isEditable = focusedElement.hasAttribute('contenteditable') && focusedElement.getAttribute('contenteditable') === 'true';
    
              if (!isInputFocused && !isEditable) {
                e.preventDefault(); 
                deleteSelectedElement();
              }
            }
          });
    
          // 标签页切换
          templateTab.addEventListener('click', () => switchTab('templateTab'));
          textTab.addEventListener('click', () => switchTab('textTab'));
          assetTab.addEventListener('click', () => switchTab('assetTab'));
    
          // 模板搜索
          templateSearchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = state.allTemplates.filter(t => 
              t.name.toLowerCase().includes(keyword) || 
              t.description.toLowerCase().includes(keyword)
            );
            renderTemplateList(filtered);
          });
          
          // 模板分类筛选 
          document.querySelectorAll('.template-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const category = e.target.getAttribute('data-category');
              
              document.querySelectorAll('.template-category-btn').forEach(b => {
                b.classList.remove('bg-blue-500', 'text-white');
                b.classList.add('text-gray-600', 'hover:bg-gray-100');
              });
              e.target.classList.add('bg-blue-500', 'text-white');
              e.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
              
              const filtered = state.allTemplates.filter(t => category === 'all' || t.category === category);
              renderTemplateList(filtered);
            });
          });
    
          // 模板点击
          templateListEl.addEventListener('click', (e) => {
            const card = e.target.closest('.template-card');
            if (card) {
              const templateId = card.getAttribute('data-id');
              loadTemplateToCanvas(templateId);
            }
          });
          
          // <<< 新增文本库点击事件 >>>
          // 添加空白文本框
          addBlankTextCard.addEventListener('click', addBlankTextToCanvas);

          // 预设文本模板点击
          textTemplateListEl.addEventListener('click', (e) => {
            const card = e.target.closest('.template-card');
            if (card) {
              const templateId = card.getAttribute('data-id');
              loadTemplateToCanvas(templateId); // 重用加载模板函数
            }
          });
          // <<< 新增结束 >>>
    
          // 标志分类筛选
          document.querySelectorAll('.asset-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              document.querySelectorAll('.asset-category-btn').forEach(b => {
                b.classList.remove('bg-blue-500', 'text-white');
                b.classList.add('text-gray-600', 'hover:bg-gray-100');
              });
              e.target.classList.add('bg-blue-500', 'text-white');
              e.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
              
              state.currentCategory = e.target.getAttribute('data-category');
              filterAssets();
            });
          });
    
          // 标志搜索
          assetSearchInput.addEventListener('input', filterAssets);
    
          // 标志点击添加
          assetListEl.addEventListener('click', (e) => {
            const card = e.target.closest('.asset-card');
            if (card) {
              const src = card.getAttribute('data-src');
              addAssetToCanvas(src);
            }
          });
    
          // 画布尺寸应用
          applySizeBtn.addEventListener('click', applyCanvasSize);
    
          // 导出按钮
          exportBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportOptions.classList.toggle('hidden');
          });
    
          document.addEventListener('click', () => {
            exportOptions.classList.add('hidden');
          });
    
          exportOptions.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const format = btn.getAttribute('data-format');
              exportCanvas(format);
              exportOptions.classList.add('hidden');
            });
          });
        }
    
        // 启动
        window.addEventListener('DOMContentLoaded', init);
      </script>

</body>
</html>
