<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>跨境电商物流合规面单编辑器</title>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .template-card {
        @apply border border-gray-200 rounded-md p-2 mb-3 cursor-pointer hover:bg-gray-50 transition-all;
      }
      .template-card.active {
        @apply border-blue-500 bg-blue-50;
      }
      .asset-card {
        @apply border border-gray-200 rounded-md p-2 mb-2 cursor-pointer hover:bg-gray-50 transition-all;
      }
      .canvas-container {
        @apply border border-gray-300 rounded-md bg-white relative overflow-hidden;
      }
      .canvas-element {
        @apply absolute select-none;
      }
      .editable {
        /* 避免在拖动时显示光标，编辑时仍然有效 */
        @apply cursor-move; 
        outline-offset: 4px; /* 增加轮廓偏移，更容易点击边缘拖动 */
        min-width: 20px; /* 确保最小可点击区域 */
      }
      /* 缩放手柄样式 */
      .resize-handle {
        @apply absolute w-4 h-4 bg-blue-500 rounded-full border border-white shadow-md z-10 hidden;
      }
      /* 选中时显示手柄 */
      .selected .resize-handle {
        @apply block;
      }
      .resize-handle-tl { top: -6px; left: -6px; cursor: nwse-resize; }
      .resize-handle-tr { top: -6px; right: -6px; cursor: nesw-resize; }
      .resize-handle-bl { bottom: -6px; left: -6px; cursor: nesw-resize; }
      .resize-handle-br { bottom: -6px; right: -6px; cursor: nwse-resize; }
      
      /* 选中元素轮廓 */
      .canvas-element.selected {
        @apply outline outline-2 outline-blue-500;
      }
      
      /* 确保图片元素在容器内显示 */
      .canvas-element img {
        display: block;
        max-width: 100%;
        max-height: 100%;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
    }
  </style>
</head>
<body class="flex h-screen bg-gray-100 overflow-hidden">

  <div class="w-16 flex flex-col items-center py-4 border-r border-gray-200 bg-white">
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-paint-brush text-xl mb-1"></i>
      <span class="text-xs">绘制</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-font text-xl mb-1"></i>
      <span class="text-xs">文字</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-square-o text-xl mb-1"></i>
      <span class="text-xs">形状</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-blue-600 transition-colors">
      <i class="fa fa-picture-o text-xl mb-1"></i>
      <span class="text-xs">标志</span>
    </button>
    <button class="flex flex-col items-center text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-th-large text-xl mb-1"></i>
      <span class="text-xs">模板</span>
    </button>
  </div>

  <div class="w-72 border-r border-gray-200 flex flex-col bg-white">
    <div class="border-b border-gray-200">
      <div class="flex">
        <button id="templateTab" class="flex-1 py-3 text-center text-sm font-medium text-blue-600 border-b-2 border-blue-600">
          模板库
        </button>
        <button id="assetTab" class="flex-1 py-3 text-center text-sm font-medium text-gray-500 hover:text-gray-700">
          标志库
        </button>
      </div>
    </div>

    <div id="templateLibrary" class="flex-1 overflow-y-auto scrollbar-hide p-3">
      <div class="mb-4">
        <input type="text" id="templateSearch" placeholder="搜索合规模板" 
               class="w-full px-3 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        <div class="flex mt-2 space-x-1">
          <button class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm">全部</button>
          <button class="px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100">寄件人</button>
          <button class="px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100">制造商</button>
        </div>
      </div>
      <div id="templateList" class="space-y-2">
        <div class="text-center text-gray-500 py-10">加载模板中...</div>
      </div>
    </div>

    <div id="assetLibrary" class="hidden flex-1 overflow-y-auto scrollbar-hide p-3">
      <div class="mb-4">
        <input type="text" id="assetSearch" placeholder="搜索标志（如：窒息警告）" 
               class="w-full px-3 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        
        <div class="mt-3 overflow-x-auto scrollbar-hide">
          <div class="flex space-x-2 pb-2 min-w-max">
            <button class="asset-category-btn px-3 py-1 bg-blue-500 text-white rounded-md text-sm" data-category="all">
              全部
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="代理">
              代理
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="法国标">
              法国标
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="化妆品">
              化妆品
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="能效">
              能效
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="纽扣电池">
              纽扣电池
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="西班牙回收">
              西班牙回收
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="窒息警告">
              窒息警告
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="其他">
              其他
            </button>
          </div>
        </div>
      </div>

      <div id="assetList" class="space-y-3">
        <div class="text-center text-gray-500 py-10">加载标志中...</div>
      </div>
    </div>
  </div>

  <div class="flex-1 flex flex-col overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
      <div class="text-sm text-gray-500 flex items-center">
        <i class="fa fa-info-circle mr-1"></i>
        <span>合规面单请确保所有信息完整，标志位置正确</span>
      </div>
      <div class="flex items-center">
        <span class="text-sm mr-2">画布尺寸:</span>
        <input type="number" id="canvasWidth" value="210" min="50" max="500" 
               class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
        <span class="mx-1">×</span>
        <input type="number" id="canvasHeight" value="148" min="50" max="500" 
               class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
        <span class="ml-1 mr-3">mm</span>
        <button id="applySizeBtn" class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">应用</button>
      </div>
    </div>
    
    <div class="flex-1 p-6 overflow-auto bg-gray-50">
      <div class="max-w-4xl mx-auto">
        <div id="canvasContainer" class="canvas-container mx-auto transition-all duration-300" 
             style="width: 210mm; height: 148mm;">
          <div id="canvas" class="w-full h-full relative">
            <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">
              请从左侧选择模板或标志添加到画布
            </div>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end">
          <div class="relative inline-block">
            <button id="exportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
              导出合规面单 <i class="fa fa-download ml-1"></i>
            </button>
            <div id="exportOptions" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
              <button data-format="pdf" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-pdf-o mr-2 text-red-500"></i>PDF格式（推荐）
              </button>
              <button data-format="png" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-image-o mr-2 text-green-500"></i>PNG格式
              </button>
              <button data-format="jpg" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-image-o mr-2 text-yellow-500"></i>JPG格式
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="propertyPanel" class="fixed top-16 right-6 w-56 p-4 bg-white rounded-lg shadow-xl hidden z-20">
    <h3 class="text-sm font-bold mb-3 border-b pb-2 text-gray-700">文本属性</h3>
    <div id="textControls" class="space-y-3">
      <div class="flex justify-between items-center">
        <label for="fontSizeSelect" class="text-sm text-gray-600">字号 (px):</label>
        <select id="fontSizeSelect" class="w-24 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-blue-500 focus:border-blue-500">
          </select>
      </div>
    </div>
  </div>


    <script>
        // 对应 templates/text.json 的模板 ID
        const TEXT_TEMPLATE_ID = 'text-template'; 
        const TEXT_TEMPLATE_PATH = './templates/text.json';

        // 模拟 text.json 文件的内容 (因为它在实际文件系统中可能不存在)
        // 用户可以根据这个结构创建 text.json 文件
        const TEXT_JSON_CONTENT = {
            elements: [
                {
                    type: 'text',
                    position: { x: 0, y: 0 }, // 初始位置不重要，loadTemplateToCanvas 会计算居中
                    content: 'This is a text area', // 用户要求的内置文字内容
                    style: { fontSize: 14, fontWeight: 'normal', color: '#000' },
                    editable: true
                }
            ]
        };

        // text.json 对应的元数据 (用于模板列表展示)
        const TEXT_TEMPLATE_META = {
            id: TEXT_TEMPLATE_ID,
            name: '内置文本框',
            description: '点击插入一个可移动、可编辑的文本框。',
            thumbnail: 'https://via.placeholder.com/100x75/007bff/ffffff?text=Text+Box', 
            path: TEXT_TEMPLATE_PATH, 
            size: { width: 210, height: 148, unit: 'mm' } // 插入时的默认画布尺寸 (A5)
        };

        const state = {
          currentTemplate: null,
          allTemplates: [],
          allAssets: [],
          filteredAssets: [],
          currentCategory: 'all',
          repoName: 'miandan' // 你的仓库名称
        };
    
        // UPDATED: 资产分类 (移除 '文本' 类别)
        const assetCategories = [
          '代理', '法国标', '化妆品', '能效', 
          '纽扣电池', '西班牙回收', '窒息警告', '其他'
        ];
    
        // DOM元素
        const canvas = document.getElementById('canvas');
        const canvasContainer = document.getElementById('canvasContainer');
        const canvasWidthInput = document.getElementById('canvasWidth');
        const canvasHeightInput = document.getElementById('canvasHeight');
        const applySizeBtn = document.getElementById('applySizeBtn');
        const exportBtn = document.getElementById('exportBtn');
        const exportOptions = document.getElementById('exportOptions');
        const templateListEl = document.getElementById('templateList');
        const templateSearchInput = document.getElementById('templateSearch');
        const assetListEl = document.getElementById('assetList');
        const assetSearchInput = document.getElementById('assetSearch');
        const templateTab = document.getElementById('templateTab');
        const assetTab = document.getElementById('assetTab');
        const templateLibrary = document.getElementById('templateLibrary');
        const assetLibrary = document.getElementById('assetLibrary');
        // NEW: 属性面板DOM
        const propertyPanel = document.getElementById('propertyPanel');
        const fontSizeSelect = document.getElementById('fontSizeSelect');
        let selectedTextElement = null; // 跟踪当前选中的文本元素
    
        // 像素到毫米的转换因子 (1px ≈ 0.264583mm, 1mm ≈ 3.779528px)
        const MM_TO_PX = 3.779528;
        const PX_TO_MM = 0.264583;
    
        // 初始化
        async function init() {
          await Promise.all([
            loadTemplateMetadata(),
            loadAllAssets()
          ]);
          populateFontSizeOptions(); // 填充字号选项
          initEventListeners();
          initInteractJs(); // 初始化interact.js
        }

        // 填充字号选项
        function populateFontSizeOptions() {
            for (let i = 8; i <= 36; i += 2) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i + 'px';
                fontSizeSelect.appendChild(option);
            }
        }
    
        // 加载模板元数据 (新增 text.json 元数据)
        async function loadTemplateMetadata() {
          try {
            // 尝试加载远程模板元数据
            const response = await fetch(`/${state.repoName}/templates/metadata.json`);
            const data = await response.json();
            let templates = data.templates;

            // 1. 添加内置文本模板到列表的开头
            templates.unshift(TEXT_TEMPLATE_META);

            state.allTemplates = templates;
            renderTemplateList(templates);
          } catch (error) {
            // 如果远程加载失败，至少显示内置文本模板
            state.allTemplates = [TEXT_TEMPLATE_META];
            renderTemplateList(state.allTemplates);
            console.error('模板元数据加载失败，仅显示内置文本模板：', error);
          }
        }
    
        // 加载标志资源 (保持不变)
        async function loadAllAssets() {
          try {
            const allAssets = [];
            
            // 1. 加载图片资产
            for (const category of assetCategories) {
              for (let i = 1; i <= 10; i++) {
                const src = `/${state.repoName}/assets/images/${category}/${category}${i}.jpg`;
                const asset = {
                  id: `${category}-${i}`,
                  category,
                  name: `${category}${i}`,
                  src: src
                };
                const exists = await checkImageExists(src);
                if (exists) {
                  allAssets.push(asset);
                } else {
                  break;
                }
              }
            }
            
            state.allAssets = allAssets;
            state.filteredAssets = allAssets;
            renderAssetList(allAssets);
          } catch (error) {
            assetListEl.innerHTML = '<div class="text-center text-red-500 py-10">标志加载失败</div>';
            console.error('标志资源加载失败：', error);
          }
        }
    
        // 检查图片是否存在 (保持不变)
        function checkImageExists(src) {
          return new Promise(resolve => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = src;
          });
        }
    
        // 渲染模板列表
        function renderTemplateList(templates) {
          if (templates.length === 0) {
            templateListEl.innerHTML = '<div class="text-center text-gray-500 py-10">无合规模板数据</div>';
            return;
          }
    
          templateListEl.innerHTML = templates.map(template => {
            const isTextBox = template.id === TEXT_TEMPLATE_ID;
            
            return `
                <div class="template-card ${isTextBox ? 'border-blue-300 bg-blue-50' : ''}" data-id="${template.id}">
                    <div class="aspect-[4/3] ${isTextBox ? 'bg-blue-100 flex items-center justify-center' : 'bg-gray-100'} rounded overflow-hidden mb-2">
                        ${isTextBox 
                            ? `<i class="fa fa-font text-blue-600 text-3xl"></i>` 
                            : `<img src="${template.thumbnail.replace('./', `/${state.repoName}/`)}" alt="${template.name}" class="w-
