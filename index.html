<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¨¡å—åŒ–é¢å• DIY è®¾è®¡å™¨ - å®Œæ•´äº¤äº’æ–¹æ¡ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        /* å¸ƒå±€å®¹å™¨ */
        #app-container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: auto;
        }

        /* ä¾§è¾¹æ ï¼šæ¨¡æ¿å’Œå·¥å…· */
        #sidebar {
            width: 300px;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            flex-shrink: 0; /* ä¸å‹ç¼©ä¾§è¾¹æ  */
        }

        h3 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 20px;
        }

        /* æ¨¡æ¿é¢„è§ˆæ ·å¼ */
        .template-preview {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .template-preview:hover {
            background-color: #e6f7ff;
        }

        /* ç”»å¸ƒåŒºåŸŸæ ·å¼ */
        #designer-area {
            flex-grow: 1;
        }

        #canvas-container {
            width: 800px; /* æ¨¡æ‹Ÿé¢å•å®½åº¦ */
            height: 500px; /* æ¨¡æ‹Ÿé¢å•é«˜åº¦ */
            border: 2px solid #333;
            background-color: #fff;
            position: relative;
            margin: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* ä¿æŒæ¨¡å—åœ¨è¾¹ç•Œå†… */
        }

        /* æ¨¡å—é€šç”¨æ ·å¼ */
        .module {
            position: absolute;
            min-width: 50px;
            min-height: 20px;
            padding: 5px;
            cursor: move;
            user-select: none;
            box-sizing: border-box;
            background-color: rgba(255, 255, 0, 0.1); /* æ–¹ä¾¿è¯†åˆ« */
            border: 1px solid #888;
            outline: none; /* ç§»é™¤é»˜è®¤ç„¦ç‚¹è½®å»“ */
        }
        
        /* é€‰ä¸­æ¨¡å—æ ·å¼ */
        .module.active {
            border: 2px solid #007bff;
            background-color: rgba(0, 123, 255, 0.1);
        }

        /* è°ƒæ•´å¤§å°æ‰‹æŸ„æ ·å¼ (ç”± interact.js è‡ªåŠ¨ç”Ÿæˆ) */
        .module.interact-resizable {
            /* ä¿æŒåŸæ · */
        }

        /* æ¨¡å—ç±»å‹æ ·å¼ */
        .module-text {
            font-size: 14px;
            font-weight: normal;
            display: flex;
            align-items: center;
        }

        .module-barcode {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #000;
            background-color: #eee;
            font-family: monospace;
            font-size: 12px;
        }

        .module-line {
            background-color: #000;
            height: 2px !important; /* ç¡®ä¿çº¿å½¢æ¨¡å—çš„åšåº¦ */
            min-height: 2px !important;
            border: none;
        }

        /* æ§åˆ¶æŒ‰é’® */
        #controls button {
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div id="sidebar">
            <h2>ğŸ“¦ é¢å•è®¾è®¡å·¥å…·</h2>

            <h3>æ¨¡å—å·¥å…·</h3>
            <button onclick="addModule('text')">â• æ–‡æœ¬åŒº</button>
            <button onclick="addModule('barcode')">â• æ¡å½¢ç </button>
            <button onclick="addModule('line')">â• åˆ†å‰²çº¿</button>
            <button onclick="deleteActiveModule()" style="background-color: #dc3545;">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
            
            <h3>é¢„è®¾æ¨¡æ¿</h3>
            <div id="templates-list">
                </div>

            <h3>æ“ä½œ</h3>
            <button onclick="saveLayout()" style="background-color: #28a745;">ğŸ’¾ ä¿å­˜å¸ƒå±€</button>
            <button onclick="loadLayoutFromJSON()" style="background-color: #ffc107; color: #333;">ğŸ“¤ å¯¼å…¥ JSON</button>
        </div>

        <div id="designer-area">
            <h1>é¢å•è®¾è®¡ç”»å¸ƒ</h1>
            <div id="canvas-container">
                </div>
            <div id="status-bar" style="margin-top: 10px; font-size: 12px;">
                å½“å‰é€‰ä¸­æ¨¡å— ID: æ— 
            </div>
        </div>
    </div>

<script>
    // =================================================================
    // JavaScript Logic (designer.js equivalent)
    // =================================================================
    const canvas = document.getElementById('canvas-container');
    const statusBar = document.getElementById('status-bar');
    let moduleCounter = 0;

    // --- 1. æ¨¡æ¿æ•°æ®æ¨¡æ‹Ÿ ---
    // å®é™…é¡¹ç›®ä¸­ï¼Œè¿™äº› JSON ä¼šä» templates/ æ–‡ä»¶å¤¹ä¸­åŠ è½½
    const TEMPLATES = [
        {
            id: 'sender-info',
            name: 'å¯„ä»¶äººåŸºç¡€æ¨¡æ¿',
            description: 'åŒ…å«å¯„ä»¶äººå§“åå’Œåœ°å€',
            data: {
                "modules": [
                    { "id": "m1", "type": "text", "x": 30, "y": 30, "width": 300, "height": 30, "content": "å¯„ä»¶äºº: {{sender_name}}", "fontSize": 14 },
                    { "id": "m2", "type": "text", "x": 30, "y": 70, "width": 400, "height": 40, "content": "åœ°å€: {{sender_address}}", "fontSize": 14 },
                    { "id": "m3", "type": "line", "x": 20, "y": 120, "width": 760, "height": 2, "content": "" }
                ]
            }
        },
        {
            id: 'manufacturer-info',
            name: 'åˆ¶é€ å•†/æ‰¹æ¬¡æ¨¡æ¿',
            description: 'åŒ…å«åˆ¶é€ å•†å’Œæ‰¹æ¬¡å·',
            data: {
                "modules": [
                    { "id": "m4", "type": "text", "x": 450, "y": 30, "width": 300, "height": 25, "content": "åˆ¶é€ å•†: XX å…¬å¸", "fontSize": 12 },
                    { "id": "m5", "type": "text", "x": 450, "y": 60, "width": 300, "height": 25, "content": "æ‰¹æ¬¡å·: {{batch_number}}", "fontSize": 12 },
                    { "id": "m6", "type": "barcode", "x": 50, "y": 350, "width": 700, "height": 80, "content": "Tracking: {{tracking_id}}", "fontSize": 12 }
                ]
            }
        }
    ];

    // --- 2. äº¤äº’é€»è¾‘ (interact.js) ---

    // æ ¸å¿ƒäº¤äº’ï¼šæ‹–æ‹½å’Œè°ƒæ•´å¤§å°
    interact('.module')
        .draggable({
            // é™åˆ¶æ‹–æ‹½èŒƒå›´åœ¨ç”»å¸ƒå†…
            modifiers: [
                interact.modifiers.restrictRect({
                    restriction: 'parent',
                    endOnly: true
                })
            ],
            listeners: {
                move: dragMoveListener,
                end: updateStatusBar
            }
        })
        .resizable({
            // é™åˆ¶è°ƒæ•´å¤§å°èŒƒå›´
            edges: { left: true, right: true, bottom: true, top: true },
            listeners: {
                move: resizeMoveListener,
                end: updateStatusBar
            }
        })
        .on('tap', (event) => {
            setActiveModule(event.currentTarget);
        });

    function dragMoveListener (event) {
        const target = event.target;
        // ä¿æŒ x/y å±æ€§ (ç”¨äºæ‹–æ‹½)
        const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
        const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

        // åº”ç”¨ CSS å˜æ¢ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹ style.left/top
        target.style.transform = `translate(${x}px, ${y}px)`;

        // æ›´æ–° data å±æ€§
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
    }

    function resizeMoveListener (event) {
        const target = event.target;
        let x = (parseFloat(target.getAttribute('data-x')) || 0);
        let y = (parseFloat(target.getAttribute('data-y')) || 0);

        // æ›´æ–°å…ƒç´ çš„å®½åº¦å’Œé«˜åº¦
        target.style.width = event.rect.width + 'px';
        target.style.height = event.rect.height + 'px';

        // è°ƒæ•´ä½ç½® (å½“ä»å·¦ä¾§æˆ–é¡¶éƒ¨è°ƒæ•´å¤§å°æ—¶)
        x += event.deltaRect.left;
        y += event.deltaRect.top;

        target.style.transform = `translate(${x}px, ${y}px)`;

        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
    }

    // --- 3. æ¨¡å—ç®¡ç†å‡½æ•° ---

    function createModuleElement(data) {
        const mod = document.createElement('div');
        mod.id = data.id;
        mod.className = `module module-${data.type}`;
        mod.innerHTML = data.content;
        
        // åˆå§‹ä½ç½®å’Œå°ºå¯¸
        mod.style.width = data.width + 'px';
        mod.style.height = data.height + 'px';
        
        // åˆå§‹å˜æ¢ï¼ˆå®šä½ï¼‰
        mod.style.transform = `translate(${data.x}px, ${data.y}px)`;
        mod.setAttribute('data-x', data.x);
        mod.setAttribute('data-y', data.y);

        // å…¶ä»–æ ·å¼
        if (data.fontSize) mod.style.fontSize = data.fontSize + 'px';
        if (data.lineColor) mod.style.backgroundColor = data.lineColor;
        
        // é‡æ–°åˆå§‹åŒ– interact.js å¯¹æ–°å…ƒç´ çš„ç›‘å¬
        interact(mod).unset(); // å–æ¶ˆæ—§ç›‘å¬ï¼Œé˜²æ­¢é‡å¤
        interact(mod)
            .draggable({ modifiers: [interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true })] })
            .resizable({ edges: { left: true, right: true, bottom: true, top: true } })
            .on('tap', (event) => { setActiveModule(event.currentTarget); });

        return mod;
    }

    function addModule(type) {
        moduleCounter++;
        let data = {
            id: `mod-${type}-${moduleCounter}`,
            type: type,
            x: 50,
            y: 50 + (moduleCounter * 10), // é”™å¼€ä½ç½®
            width: 200,
            height: 40,
            content: `[${type.toUpperCase()}: æ–°æ¨¡å— ${moduleCounter}]`,
            fontSize: 14
        };
        
        if (type === 'line') {
            data.width = 400;
            data.height = 2;
            data.content = '';
            data.lineColor = '#000';
        }

        const newModule = createModuleElement(data);
        canvas.appendChild(newModule);
        setActiveModule(newModule);
    }

    function deleteActiveModule() {
        const activeMod = document.querySelector('.module.active');
        if (activeMod) {
            interact(activeMod).unset(); // ç§»é™¤ interact.js ç›‘å¬
            activeMod.remove();
            statusBar.innerText = 'å½“å‰é€‰ä¸­æ¨¡å— ID: æ—  (å·²åˆ é™¤)';
        } else {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å—è¿›è¡Œåˆ é™¤ã€‚');
        }
    }

    function setActiveModule(mod) {
        document.querySelectorAll('.module').forEach(m => m.classList.remove('active'));
        mod.classList.add('active');
        updateStatusBar(mod);
    }

    function updateStatusBar(mod = null) {
        const activeMod = mod || document.querySelector('.module.active');
        if (activeMod) {
            const x = parseFloat(activeMod.getAttribute('data-x')) || 0;
            const y = parseFloat(activeMod.getAttribute('data-y')) || 0;
            const w = activeMod.offsetWidth;
            const h = activeMod.offsetHeight;
            statusBar.innerHTML = `
                å½“å‰é€‰ä¸­æ¨¡å— ID: **${activeMod.id}** | X: ${Math.round(x)} | Y: ${Math.round(y)} 
                | W: ${Math.round(w)} | H: ${Math.round(h)}
            `;
        } else {
            statusBar.innerText = 'å½“å‰é€‰ä¸­æ¨¡å— ID: æ— ';
        }
    }


    // --- 4. æ¨¡æ¿å’Œæ•°æ®å¯¼å…¥å¯¼å‡º ---

    function renderTemplates() {
        const list = document.getElementById('templates-list');
        TEMPLATES.forEach(t => {
            const div = document.createElement('div');
            div.className = 'template-preview';
            div.innerHTML = `<strong>${t.name}</strong><br><small>${t.description}</small>`;
            div.onclick = () => loadTemplate(t.data);
            list.appendChild(div);
        });
    }

    function loadTemplate(data) {
        if (!confirm('åŠ è½½æ–°æ¨¡æ¿å°†æ¸…é™¤å½“å‰ç”»å¸ƒä¸Šçš„æ‰€æœ‰æ¨¡å—ã€‚ç¡®å®šåŠ è½½å—ï¼Ÿ')) {
            return;
        }
        
        // ç§»é™¤æ‰€æœ‰æ—§æ¨¡å—
        canvas.innerHTML = ''; 
        
        // æ¸…é™¤ interact.js ç›‘å¬ (è™½ç„¶ç†è®ºä¸Š remove() ä¼šè‡ªåŠ¨å¤„ç†)
        document.querySelectorAll('.module').forEach(m => interact(m).unset());
        
        // éå†å¹¶é‡å»ºæ–°æ¨¡å—
        data.modules.forEach(moduleData => {
            canvas.appendChild(createModuleElement(moduleData));
        });
        
        updateStatusBar();
        alert(`æ¨¡æ¿ "${TEMPLATES.find(t => t.data === data)?.name || 'è‡ªå®šä¹‰'}" å·²åŠ è½½!`);
    }

    function saveLayout() {
        const currentModules = [];
        canvas.querySelectorAll('.module').forEach(mod => {
            const x = parseFloat(mod.getAttribute('data-x')) || 0;
            const y = parseFloat(mod.getAttribute('data-y')) || 0;
            
            // æå–æ¨¡å—ä¿¡æ¯
            const moduleData = {
                id: mod.id,
                type: mod.className.includes('module-text') ? 'text' : mod.className.includes('module-barcode') ? 'barcode' : 'line',
                x: Math.round(x),
                y: Math.round(y),
                width: mod.offsetWidth,
                height: mod.offsetHeight,
                content: mod.innerText.trim(),
                fontSize: parseInt(mod.style.fontSize) || 14,
                // å®é™…é¡¹ç›®ä¸­è¿˜åº”ä¿å­˜æ›´å¤šæ ·å¼å±æ€§
            };
            currentModules.push(moduleData);
        });

        const layoutData = {
            templateName: "ç”¨æˆ·è‡ªå®šä¹‰ä¿å­˜å¸ƒå±€",
            modules: currentModules
        };

        const jsonString = JSON.stringify(layoutData, null, 2);
        
        // å¯¼å‡º/ä¿å­˜åŠŸèƒ½ï¼šæç¤ºç”¨æˆ·å¤åˆ¶ JSON
        console.log('--- ä¿å­˜çš„å¸ƒå±€ JSON æ•°æ® ---');
        console.log(jsonString);
        alert('å¸ƒå±€å·²ä¿å­˜! è¯·æŸ¥çœ‹æµè§ˆå™¨ Console (F12) å¤åˆ¶ JSON æ•°æ®ã€‚');
    }
    
    // æ¨¡æ‹Ÿå¯¼å…¥åŠŸèƒ½ï¼ˆè®©ç”¨æˆ·ç²˜è´´ JSONï¼‰
    function loadLayoutFromJSON() {
        const jsonText = prompt("è¯·ç²˜è´´æ‚¨çš„å¸ƒå±€ JSON æ•°æ®:", "");
        if (jsonText) {
            try {
                const data = JSON.parse(jsonText);
                if (data.modules && Array.isArray(data.modules)) {
                    loadTemplate(data);
                } else {
                    alert('å¯¼å…¥å¤±è´¥: JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘ "modules" æ•°ç»„ã€‚');
                }
            } catch (e) {
                alert('å¯¼å…¥å¤±è´¥: æ— æ•ˆçš„ JSON æ ¼å¼ã€‚');
                console.error(e);
            }
        }
    }

    // åˆå§‹åŒ–ï¼šåŠ è½½æ¨¡æ¿åˆ—è¡¨
    document.addEventListener('DOMContentLoaded', () => {
        renderTemplates();
        // åˆå§‹åŠ è½½ä¸€ä¸ªç©ºæ¨¡å—
        addModule('text'); 
    });
</script>
</body>
</html>
