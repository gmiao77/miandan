<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>跨境电商物流合规面单编辑器</title>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .template-card {
        @apply border border-gray-200 rounded-md p-2 mb-3 cursor-pointer hover:bg-gray-50 transition-all;
      }
      .template-card.active {
        @apply border-blue-500 bg-blue-50;
      }
      .asset-card {
        @apply border border-gray-200 rounded-md p-2 mb-2 cursor-pointer hover:bg-gray-50 transition-all;
      }
      .canvas-container {
        @apply border border-gray-300 rounded-md bg-white relative overflow-hidden;
      }
      .canvas-element {
        @apply absolute select-none;
      }
      .editable {
        @apply cursor-text outline-none;
      }
      /* 缩放手柄样式 */
      .resize-handle {
        @apply absolute w-4 h-4 bg-blue-500 rounded-full border border-white shadow-md z-10 hidden;
      }
      /* 选中时显示手柄 */
      .selected .resize-handle {
        @apply block;
      }
      .resize-handle-tl { top: -6px; left: -6px; cursor: nwse-resize; }
      .resize-handle-tr { top: -6px; right: -6px; cursor: nesw-resize; }
      .resize-handle-bl { bottom: -6px; left: -6px; cursor: nesw-resize; }
      .resize-handle-br { bottom: -6px; right: -6px; cursor: nwse-resize; }
      
      /* 选中元素轮廓 */
      .canvas-element.selected {
        @apply outline outline-2 outline-blue-500;
      }
      
      /* 确保图片元素在容器内显示 */
      .canvas-element img {
        display: block;
        max-width: 100%;
        max-height: 100%;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
    }
  </style>
</head>
<body class="flex h-screen bg-gray-100 overflow-hidden">

  <div class="w-16 flex flex-col items-center py-4 border-r border-gray-200 bg-white">
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-paint-brush text-xl mb-1"></i>
      <span class="text-xs">绘制</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-font text-xl mb-1"></i>
      <span class="text-xs">文字</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-square-o text-xl mb-1"></i>
      <span class="text-xs">形状</span>
    </button>
    <button class="flex flex-col items-center mb-6 text-blue-600 transition-colors">
      <i class="fa fa-picture-o text-xl mb-1"></i>
      <span class="text-xs">标志</span>
    </button>
    <button class="flex flex-col items-center text-gray-700 hover:text-blue-600 transition-colors">
      <i class="fa fa-th-large text-xl mb-1"></i>
      <span class="text-xs">模板</span>
    </button>
  </div>

  <div class="w-72 border-r border-gray-200 flex flex-col bg-white">
    <div class="border-b border-gray-200">
      <div class="flex">
        <button id="templateTab" class="flex-1 py-3 text-center text-sm font-medium text-gray-500 hover:text-gray-700">
          模板库
        </button>
        <button id="assetTab" class="flex-1 py-3 text-center text-sm font-medium text-blue-600 border-b-2 border-blue-600">
          标志库
        </button>
      </div>
    </div>

    <div id="templateLibrary" class="hidden flex-1 overflow-y-auto scrollbar-hide p-3">
      <div class="mb-4">
        <input type="text" id="templateSearch" placeholder="搜索合规模板" 
               class="w-full px-3 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        <div class="flex mt-2 space-x-1">
          <button class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm">全部</button>
          <button class="px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100">寄件人</button>
          <button class="px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100">制造商</button>
        </div>
      </div>
      <div id="templateList" class="space-y-2">
        <div class="text-center text-gray-500 py-10">加载模板中...</div>
      </div>
    </div>

    <div id="assetLibrary" class="flex-1 overflow-y-auto scrollbar-hide p-3">
      <div class="mb-4">
        <input type="text" id="assetSearch" placeholder="搜索标志（如：窒息警告）" 
               class="w-full px-3 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        
        <div class="mt-3 overflow-x-auto scrollbar-hide">
          <div class="flex space-x-2 pb-2 min-w-max">
            <button class="asset-category-btn px-3 py-1 bg-blue-500 text-white rounded-md text-sm" data-category="all">
              全部
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="代理">
              代理
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="法国标">
              法国标
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="化妆品">
              化妆品
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="能效">
              能效
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="纽扣电池">
              纽扣电池
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="西班牙回收">
              西班牙回收
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="窒息警告">
              窒息警告
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="文本">
              文本
            </button>
            <button class="asset-category-btn px-3 py-1 text-gray-600 rounded-md text-sm hover:bg-gray-100" data-category="其他">
              其他
            </button>
          </div>
        </div>
      </div>

      <div id="assetList" class="space-y-3">
        <div class="text-center text-gray-500 py-10">加载标志中...</div>
      </div>
    </div>
  </div>

  <div class="flex-1 flex flex-col overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
      <div class="text-sm text-gray-500 flex items-center">
        <i class="fa fa-info-circle mr-1"></i>
        <span>合规面单请确保所有信息完整，标志位置正确</span>
      </div>
      <div class="flex items-center">
        <span class="text-sm mr-2">画布尺寸:</span>
        <input type="number" id="canvasWidth" value="210" min="50" max="500" 
               class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
        <span class="mx-1">×</span>
        <input type="number" id="canvasHeight" value="148" min="50" max="500" 
               class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
        <span class="ml-1 mr-3">mm</span>
        <button id="applySizeBtn" class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-sm hover:bg-gray-300">应用</button>
      </div>
    </div>
    
    <div class="flex-1 p-6 overflow-auto bg-gray-50">
      <div class="max-w-4xl mx-auto">
        <div id="canvasContainer" class="canvas-container mx-auto transition-all duration-300" 
             style="width: 210mm; height: 148mm;">
          <div id="canvas" class="w-full h-full relative">
            <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">
              请从左侧选择模板或标志添加到画布
            </div>
          </div>
        </div>
        
        <div class="mt-6 flex justify-end">
          <div class="relative inline-block">
            <button id="exportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
              导出合规面单 <i class="fa fa-download ml-1"></i>
            </button>
            <div id="exportOptions" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-10">
              <button data-format="pdf" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-pdf-o mr-2 text-red-500"></i>PDF格式（推荐）
              </button>
              <button data-format="png" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-image-o mr-2 text-green-500"></i>PNG格式
              </button>
              <button data-format="jpg" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <i class="fa fa-file-image-o mr-2 text-yellow-500"></i>JPG格式
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


    <script>
        const state = {
          currentTemplate: null,
          allTemplates: [],
          allAssets: [],
          filteredAssets: [],
          currentCategory: 'all',
          repoName: 'miandan' // 你的仓库名称
        };
    
        // NEW: 内置文本资产定义
        const builtInTextAssets = [
          { 
            id: 'text-title', 
            category: '文本', 
            name: '标题文本', 
            content: '请在此输入标题', 
            style: { fontSize: 16, fontWeight: 'bold', color: '#000', textAlign: 'center' } 
          },
          { 
            id: 'text-normal', 
            category: '文本', 
            name: '普通文本', 
            content: '点击编辑文本内容', 
            style: { fontSize: 10, color: '#333' } 
          },
          { 
            id: 'text-small', 
            category: '文本', 
            name: '小字提示', 
            content: '注意：易碎品', 
            style: { fontSize: 8, color: '#e53e3e' } 
          }
        ];
    
        // UPDATED: 资产分类，加入了“文本”
        const assetCategories = [
          '代理', '法国标', '化妆品', '能效', 
          '纽扣电池', '西班牙回收', '窒息警告', '文本', '其他'
        ];
    
        // DOM元素
        const canvas = document.getElementById('canvas');
        const canvasContainer = document.getElementById('canvasContainer');
        const canvasWidthInput = document.getElementById('canvasWidth');
        const canvasHeightInput = document.getElementById('canvasHeight');
        const applySizeBtn = document.getElementById('applySizeBtn');
        const exportBtn = document.getElementById('exportBtn');
        const exportOptions = document.getElementById('exportOptions');
        const templateListEl = document.getElementById('templateList');
        const templateSearchInput = document.getElementById('templateSearch');
        const assetListEl = document.getElementById('assetList');
        const assetSearchInput = document.getElementById('assetSearch');
        const templateTab = document.getElementById('templateTab');
        const assetTab = document.getElementById('assetTab');
        const templateLibrary = document.getElementById('templateLibrary');
        const assetLibrary = document.getElementById('assetLibrary');
    
        // 像素到毫米的转换因子 (1px ≈ 0.264583mm, 1mm ≈ 3.779528px)
        const MM_TO_PX = 3.779528;
        const PX_TO_MM = 0.264583;
    
        // 初始化
        async function init() {
          await Promise.all([
            loadTemplateMetadata(),
            loadAllAssets()
          ]);
          initEventListeners();
          initInteractJs(); // 初始化interact.js
        }
    
        // 加载模板元数据
        async function loadTemplateMetadata() {
          try {
            const response = await fetch(`/${state.repoName}/templates/metadata.json`);
            const data = await response.json();
            state.allTemplates = data.templates;
            renderTemplateList(data.templates);
          } catch (error) {
            templateListEl.innerHTML = '<div class="text-center text-red-500 py-10">模板加载失败</div>';
            console.error('模板元数据加载失败：', error);
          }
        }
    
        // 加载标志资源 (UPDATED to include text assets)
        async function loadAllAssets() {
          try {
            const allAssets = [];
            
            // 1. 加载图片资产 (保持原有逻辑)
            for (const category of assetCategories) {
              if (category === '文本') continue; // 跳过文本类别，单独处理
              for (let i = 1; i <= 10; i++) {
                const src = `/${state.repoName}/assets/images/${category}/${category}${i}.jpg`;
                const asset = {
                  id: `${category}-${i}`,
                  category,
                  name: `${category}${i}`,
                  src: src
                };
                const exists = await checkImageExists(src);
                if (exists) {
                  allAssets.push(asset);
                } else {
                  break;
                }
              }
            }
            
            // 2. 添加内置文本资产
            allAssets.push(...builtInTextAssets);
            
            state.allAssets = allAssets;
            state.filteredAssets = allAssets;
            renderAssetList(allAssets);
          } catch (error) {
            assetListEl.innerHTML = '<div class="text-center text-red-500 py-10">标志加载失败</div>';
            console.error('标志资源加载失败：', error);
          }
        }
    
        // 检查图片是否存在
        function checkImageExists(src) {
          return new Promise(resolve => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
            img.src = src;
          });
        }
    
        // 渲染模板列表
        function renderTemplateList(templates) {
          if (templates.length === 0) {
            templateListEl.innerHTML = '<div class="text-center text-gray-500 py-10">无合规模板数据</div>';
            return;
          }
    
          templateListEl.innerHTML = templates.map(template => `
            <div class="template-card" data-id="${template.id}">
              <div class="aspect-[4/3] bg-gray-100 rounded overflow-hidden mb-2">
                <img src="${template.thumbnail.replace('./', `/${state.repoName}/`)}" alt="${template.name}" class="w-full h-full object-cover">
              </div>
              <h3 class="text-sm font-medium text-gray-800">${template.name}</h3>
              <p class="text-xs text-gray-500">${template.description}</p>
              <p class="text-xs text-gray-400 mt-1">${template.size.width}×${template.size.height}${template.size.unit}</p>
            </div>
          `).join('');
        }
    
        // 渲染标志列表 (UPDATED to handle text assets)
        function renderAssetList(assets) {
          if (assets.length === 0) {
            assetListEl.innerHTML = '<div class="text-center text-gray-500 py-10">无标志数据</div>';
            return;
          }
    
          const assetsByCategory = {};
          assets.forEach(asset => {
            if (!assetsByCategory[asset.category]) {
              assetsByCategory[asset.category] = [];
            }
            assetsByCategory[asset.category].push(asset);
          });
    
          let html = '';
          for (const category in assetsByCategory) {
            html += `
              <div class="mb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-2">${category}</h3>
                <div class="grid grid-cols-2 gap-2">
                  ${assetsByCategory[category].map(asset => {
                    if (asset.category === '文本') {
                      // 渲染文本资产卡片
                      return `
                        <div class="asset-card text-asset-card" 
                            data-id="${asset.id}" 
                            data-type="text" 
                            data-content="${asset.content}"
                            data-style='${JSON.stringify(asset.style)}'
                            data-category="${asset.category}">
                            <div class="bg-blue-50 border border-blue-200 rounded p-2 mb-1 h-16 flex items-center justify-center overflow-hidden">
                                <p style="font-size: ${asset.style.fontSize}px; font-weight: ${asset.style.fontWeight || 'normal'}; color: ${asset.style.color}">
                                    ${asset.name}
                                </p>
                            </div>
                            <p class="text-xs text-center mt-1 text-gray-600">${asset.name}</p>
                        </div>
                      `;
                    } else {
                      // 渲染图片资产卡片
                      return `
                        <div class="asset-card" data-id="${asset.id}" data-type="image" data-src="${asset.src}" data-category="${asset.category}">
                            <div class="bg-gray-100 rounded overflow-hidden aspect-square">
                                <img src="${asset.src}" alt="${asset.name}" class="w-full h-full object-contain p-1">
                            </div>
                            <p class="text-xs text-center mt-1 text-gray-600">${asset.name}</p>
                        </div>
                      `;
                    }
                  }).join('')}
                </div>
              </div>
            `;
          }
          assetListEl.innerHTML = html;
        }
    
        // 添加标志到画布
        function addAssetToCanvas(src) {
          if (canvas.children.length > 0 && canvas.children[0].classList.contains('justify-center')) {
            canvas.innerHTML = '';
          }
          
          const elementId = `asset-${Date.now()}`;
          const wrapper = document.createElement('div');
          wrapper.id = elementId;
          wrapper.className = 'canvas-element selected'; 
          wrapper.dataset.type = 'image-wrapper';
          
          const img = document.createElement('img');
          img.src = src;
          img.alt = '合规标志';
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/100?text=标志缺失';
          };
          
          const handles = ['tl', 'tr', 'bl', 'br'];
          handles.forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${pos}`;
            wrapper.appendChild(handle);
          });
          
          wrapper.appendChild(img);
    
          const defaultSizeMm = 50;
          const canvasWidth = parseFloat(canvasContainer.style.width);
          const canvasHeight = parseFloat(canvasContainer.style.height);
          
          wrapper.style.left = `${(canvasWidth - defaultSizeMm) / 2}mm`;
          wrapper.style.top = `${(canvasHeight - defaultSizeMm) / 2}mm`;
          wrapper.style.width = `${defaultSizeMm}mm`;
          wrapper.style.height = `${defaultSizeMm}mm`;
          
          canvas.appendChild(wrapper);
    
          document.querySelectorAll('.canvas-element').forEach(el => {
            if (el !== wrapper) el.classList.remove('selected');
          });
          
          setupInteractForElement(wrapper); 
        }

        // NEW: 添加文本元素到画布
        function addTextElementToCanvas(content, style) {
          if (canvas.children.length > 0 && canvas.children[0].classList.contains('justify-center')) {
            canvas.innerHTML = '';
          }

          const elementId = `text-${Date.now()}`;
          const element = {
              type: 'text',
              position: { x: 0, y: 0 }, // 初始位置将重新计算
              content: content,
              style: style,
              editable: true
          };
          
          const domElement = createTextElement(elementId, element);

          const canvasWidth = parseFloat(canvasContainer.style.width); // in mm
          const canvasHeight = parseFloat(canvasContainer.style.height); // in mm
          
          // 初始位置: 靠近画布中心 (CSS position属性)
          const defaultX = (canvasWidth / 2) - 30; 
          const defaultY = (canvasHeight / 2) - 10;
          
          domElement.style.left = `${defaultX}mm`;
          domElement.style.top = `${defaultY}mm`;

          canvas.appendChild(domElement);

          // 取消其他元素的选中状态
          document.querySelectorAll('.canvas-element').forEach(el => {
              if (el !== domElement) el.classList.remove('selected');
          });

          // 选中新元素
          domElement.classList.add('selected');
          
          // 确保新元素的初始像素位置被正确设置，以便拖拽
          domElement.setAttribute('data-x', domElement.offsetLeft);
          domElement.setAttribute('data-y', domElement.offsetTop);
        }
    
        // 渲染模板元素
        function renderTemplateElements(elements) {
          canvas.innerHTML = '';
          
          elements.forEach((element, index) => {
            const elementId = `element-${index}-${Date.now()}`;
            let domElement;
            
            switch (element.type) {
              case 'rect':
                domElement = createRectElement(elementId, element);
                break;
              case 'text':
                domElement = createTextElement(elementId, element);
                break;
              case 'image':
                domElement = createImageElement(elementId, element);
                break;
            }
            
            if (domElement) {
              canvas.appendChild(domElement);
              if (element.type === 'image' || element.type === 'rect') {
                setupInteractForElement(domElement); 
              }
              // 初始化位置数据，以便拖拽
              domElement.setAttribute('data-x', domElement.offsetLeft);
              domElement.setAttribute('data-y', domElement.offsetTop);
            }
          });
        }
    
        // 创建元素工具函数
        function createRectElement(id, element) {
          const div = document.createElement('div');
          div.id = id;
          div.className = 'canvas-element';
          div.dataset.type = 'rect';
          
          div.style.left = `${element.position.x}mm`;
          div.style.top = `${element.position.y}mm`;
          div.style.width = `${element.size.width}mm`;
          div.style.height = `${element.size.height}mm`;
          div.style.backgroundColor = element.style.fill || 'transparent';
          div.style.border = `${element.style.strokeWidth || 1}px solid ${element.style.stroke || '#ddd'}`;

          const handles = ['tl', 'tr', 'bl', 'br'];
          handles.forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${pos}`;
            div.appendChild(handle);
          });
          
          return div;
        }
    
        function createTextElement(id, element) {
          const div = document.createElement('div');
          div.id = id;
          div.className = 'canvas-element';
          div.dataset.type = 'text';
          
          div.style.left = `${element.position.x}mm`;
          div.style.top = `${element.position.y}mm`;
          // 样式属性
          div.style.fontSize = `${element.style.fontSize || 12}px`;
          div.style.fontWeight = element.style.fontWeight || 'normal';
          div.style.color = element.style.color || '#333';
          div.style.whiteSpace = 'nowrap';
          if (element.style.textAlign) div.style.textAlign = element.style.textAlign;
          
          div.innerText = element.content;
          if (element.editable) {
            div.contentEditable = true;
            div.classList.add('editable');
            div.setAttribute('title', '点击编辑');
          }
          
          return div;
        }
    
        function createImageElement(id, element) {
          const wrapper = document.createElement('div');
          wrapper.id = id;
          wrapper.className = 'canvas-element';
          wrapper.dataset.type = 'image-wrapper'; 
          
          const img = document.createElement('img');
          img.src = element.src.replace('./', `/${state.repoName}/`);
          img.alt = '合规标志';
          img.onerror = () => {
            img.src = 'https://via.placeholder.com/60?text=标志缺失';
          };
          
          wrapper.style.left = `${element.position.x}mm`;
          wrapper.style.top = `${element.position.y}mm`;
          wrapper.style.width = `${element.size.width}mm`;
          wrapper.style.height = `${element.size.height}mm`;
    
          const handles = ['tl', 'tr', 'bl', 'br'];
          handles.forEach(pos => {
            const handle = document.createElement('div');
            handle.className = `resize-handle resize-handle-${pos}`;
            wrapper.appendChild(handle);
          });
          
          wrapper.appendChild(img);
          
          return wrapper; 
        }
    
        // 初始化interact.js交互
        function initInteractJs() {
          interact('.canvas-element')
            .draggable({
              inertia: true, 
              modifiers: [
                interact.modifiers.restrictRect({
                  restriction: 'parent', 
                  endOnly: true
                })
              ],
              autoScroll: true,
              // FIX: 忽略可编辑文本的拖拽，使其可以正常编辑
              ignoreFrom: '.resize-handle, [contenteditable="true"]', 
              listeners: {
                move(event) {
                  const target = event.target;
                  let x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                  let y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
    
                  const mmX = x * PX_TO_MM;
                  const mmY = y * PX_TO_MM;
    
                  target.style.left = `${mmX}mm`;
                  target.style.top = `${mmY}mm`;
    
                  target.setAttribute('data-x', x);
                  target.setAttribute('data-y', y);
                }
              }
            })
            .on('down', function(event) {
              const target = event.target.closest('.canvas-element'); 
              if (!target) return;
    
              document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
                el.removeAttribute('data-x');
                el.removeAttribute('data-y');
              });
              
              target.classList.add('selected');
              
              target.setAttribute('data-x', target.offsetLeft);
              target.setAttribute('data-y', target.offsetTop);
            });
    
          interact('#canvas').on('down', function(event) {
            if (event.target === canvas) {
              document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
              });
            }
          });
        }
    
        // 为单个元素设置缩放功能
        function setupInteractForElement(element, enableResize = true) {
          if ((element.dataset.type === 'image-wrapper' || element.dataset.type === 'rect') && enableResize) {
            interact(element).resizable({
              inertia: true,
              modifiers: [
                interact.modifiers.restrictSize({
                  min: { width: 10, height: 10 }
                }),
                interact.modifiers.restrictRect({
                  restriction: 'parent', 
                  endOnly: true
                })
              ],
              edges: { 
                left: '.resize-handle-tl, .resize-handle-bl', 
                right: '.resize-handle-tr, .resize-handle-br', 
                bottom: '.resize-handle-bl, .resize-handle-br', 
                top: '.resize-handle-tl, .resize-handle-tr' 
              },
              listeners: {
                move(event) {
                  const target = event.target;
                  
                  let x = (parseFloat(target.getAttribute('data-x')) || 0);
                  let y = (parseFloat(target.getAttribute('data-y')) || 0);
                  
                  x += event.deltaRect.left;
                  y += event.deltaRect.top;
    
                  const mmWidth = event.rect.width * PX_TO_MM;
                  const mmHeight = event.rect.height * PX_TO_MM;
                  const mmX = x * PX_TO_MM;
                  const mmY = y * PX_TO_MM;
                  
                  target.style.width = `${mmWidth}mm`;
                  target.style.height = `${mmHeight}mm`;
                  target.style.left = `${mmX}mm`;
                  target.style.top = `${mmY}mm`;
    
                  target.setAttribute('data-x', x);
                  target.setAttribute('data-y', y);
                }
              }
            });
          }
        }
    
        // 画布尺寸调整
        function applyCanvasSize() {
          const width = parseInt(canvasWidthInput.value) || 100;
          const height = parseInt(canvasHeightInput.value) || 100;
          canvasContainer.style.width = `${width}mm`;
          canvasContainer.style.height = `${height}mm`;
        }
    
        // 删除选中元素的功能函数
        function deleteSelectedElement() {
          const selectedElement = document.querySelector('.canvas-element.selected');
          
          if (selectedElement) {
            selectedElement.remove();
            
            if (canvas.children.length === 0) {
                canvas.innerHTML = `
                  <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">
                    请从左侧选择模板或标志添加到画布
                  </div>
                `;
            }
          }
        }
    
        // 导出功能
        function exportCanvas(format) {
          if (canvas.children.length === 0 || canvas.querySelector('.text-gray-400')) {
            alert('请先选择并填写合规面单信息');
            return;
          }
          
          document.querySelectorAll('.canvas-element').forEach(el => {
            el.classList.remove('selected');
          });
    
          html2canvas(canvas, {
            scale: 2,
            useCORS: true
          }).then(canvasImage => {
            const imgData = canvasImage.toDataURL('image/png');
            
            if (format === 'pdf') {
              const { jsPDF } = window.jspdf;
              const pdf = new jsPDF({
                orientation: canvasWidthInput.value > canvasHeightInput.value ? 'l' : 'p',
                unit: 'mm',
                format: [parseInt(canvasWidthInput.value), parseInt(canvasHeightInput.value)]
              });
              pdf.addImage(imgData, 'PNG', 0, 0, parseInt(canvasWidthInput.value), parseInt(canvasHeightInput.value));
              pdf.save('跨境物流合规面单.pdf');
            } else {
              const link = document.createElement('a');
              link.download = `跨境物流合规面单.${format}`;
              link.href = format === 'jpg' ? imgData.replace('image/png', 'image/jpeg') : imgData;
              link.click();
            }
          });
        }
    
        // 筛选标志
        function filterAssets() {
          const keyword = assetSearchInput.value.toLowerCase();
          let filtered = state.allAssets;
          
          if (state.currentCategory !== 'all') {
            filtered = filtered.filter(asset => asset.category === state.currentCategory);
          }
          
          if (keyword) {
            filtered = filtered.filter(asset => 
              asset.name.toLowerCase().includes(keyword) || 
              asset.category.toLowerCase().includes(keyword)
            );
          }
          
          state.filteredAssets = filtered;
          renderAssetList(filtered);
        }
    
        // 事件监听
        function initEventListeners() {
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Delete' || e.key === 'Backspace') {
              const focusedElement = document.activeElement;
              const isInputFocused = (focusedElement.tagName === 'INPUT' || focusedElement.tagName === 'TEXTAREA');
              const isEditable = focusedElement.hasAttribute('contenteditable') && focusedElement.getAttribute('contenteditable') === 'true';
    
              if (!isInputFocused && !isEditable) {
                e.preventDefault();
                deleteSelectedElement();
              }
            }
          });
    
          // 标签页切换
          templateTab.addEventListener('click', () => {
            templateLibrary.classList.remove('hidden');
            assetLibrary.classList.add('hidden');
            templateTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            assetTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
          });
          
          assetTab.addEventListener('click', () => {
            assetLibrary.classList.remove('hidden');
            templateLibrary.classList.add('hidden');
            assetTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            templateTab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
          });
    
          // 模板搜索
          templateSearchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = state.allTemplates.filter(t => 
              t.name.toLowerCase().includes(keyword) || 
              t.description.toLowerCase().includes(keyword)
            );
            renderTemplateList(filtered);
          });
    
          // 模板点击
          templateListEl.addEventListener('click', (e) => {
            const card = e.target.closest('.template-card');
            if (card) {
              const templateId = card.getAttribute('data-id');
              loadTemplateToCanvas(templateId);
            }
          });
    
          // 标志分类筛选
          document.querySelectorAll('.asset-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              document.querySelectorAll('.asset-category-btn').forEach(b => {
                b.classList.remove('bg-blue-500', 'text-white');
                b.classList.add('text-gray-600', 'hover:bg-gray-100');
              });
              e.target.classList.add('bg-blue-500', 'text-white');
              e.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
              
              state.currentCategory = e.target.getAttribute('data-category');
              filterAssets();
            });
          });
    
          // 标志搜索
          assetSearchInput.addEventListener('input', filterAssets);
    
          // UPDATED: 标志/文本点击添加
          assetListEl.addEventListener('click', (e) => {
            const card = e.target.closest('.asset-card');
            if (card) {
              const type = card.getAttribute('data-type');
              
              if (type === 'image') {
                const src = card.getAttribute('data-src');
                addAssetToCanvas(src);
              } else if (type === 'text') {
                const content = card.getAttribute('data-content');
                // 解析 style 属性，因为它是 JSON 字符串
                const style = JSON.parse(card.getAttribute('data-style'));
                addTextElementToCanvas(content, style);
              }
            }
          });
    
          // 画布尺寸应用
          applySizeBtn.addEventListener('click', applyCanvasSize);
    
          // 导出按钮
          exportBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportOptions.classList.toggle('hidden');
          });
    
          document.addEventListener('click', () => {
            exportOptions.classList.add('hidden');
          });
    
          exportOptions.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const format = btn.getAttribute('data-format');
              exportCanvas(format);
              exportOptions.classList.add('hidden');
            });
          });
        }
    
        // 启动
        window.addEventListener('DOMContentLoaded', init);
      </script>

</body>
</html>
